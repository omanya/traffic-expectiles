---
title: Optimal departure time choices as quantiles and expectiles of the travel time distribution
author:
  - name: Maria Osipenko
    email: osipenko@hwr-berlin.de
    affiliation: hwr
    correspondingauthor: true
address:
  - code: hwr
    organization: Hochschule für Wirtschaft und Recht Berlin
    addressline: Badensche Str. 50
    city: Berlin
    postcode: 10825
    country: Germany
abstract: |
    We consider two alternative preference specifications for optimal departure time choices: the classical asymmetric linear loss for early and late delays, and a new specification based on asymmetric quadratic loss. We demonstrate that the resulting optimal choices correspond to the tail indices of the travel time distribution—quantiles for the asymmetric linear specification and expectiles for the asymmetric quadratic specification. Additionally, we establish a correspondence between the choices induced by these two utility specifications, showing that the asymmetric quadratic preference class is a valid alternative with favorable properties, as demonstrated through examples and applications. For both utility specifications, we derive travel time reliability ratios and present a straightforward computation method using the concepts of $\tau$-deviation and $\tau$-variance. Moreover, we test both specifications using departure time choice data, finding that the quadratic loss specification more accurately represents actual departure time choices. Finally, using Montreal travel time data for two alternative routes, we fit a mixture of gamma distributions and compare the behavior of the optimal departure time choices and travel time reliability ratio curves induced by the different utility specifications.
keywords: 
  - scheduling utility
  - asymmetric loss
  - expectiles
  - quantiles
  - travel time reliability
journal: "Transportation Research Part B: Methodological"
date: "`r Sys.Date()`"
linenumbers: false
numbersections: true
bibliography: traffic-expectiles.bib
biblio-style: elsarticle-harv # author year style for natbib - use 'elsarticle-num' or 'elsarticle-num-names' for numbered scheme
classoption: preprint, 3p, authoryear # remove authoryear is not using `elsarticle-harv`
# Use a CSL with `citation_package = "default"`
# csl: https://www.zotero.org/styles/elsevier-harvard
output:
  bookdown::pdf_book:
    base_format: rticles::elsevier_article
---



```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
#date: "`r Sys.Date()`"
#We propose a new scheduling preference specification, that influence optimal departure time choices of commuters, by generalizing the classical asymmetric linear loss on early and late delays to asymmetric $L_p$-loss.
```

<!-- \begin{abstract} -->

<!-- We consider two alternative preference specifications for optimal departure time choices: the classical asymmetric linear loss for early and late delays, and a new specification based on asymmetric quadratic loss. We demonstrate that the resulting optimal choices correspond to the tail indices of the travel time distribution. Specifically, for asymmetric linear preferences, the optimal choices are the quantiles, while for asymmetric quadratic preferences, they are the expectiles of the travel time distribution. We establish a correspondence between the choices induced by these two utility specifications, highlighting that our asymmetric quadratic preference class is a valid alternative, demonstrating favorable properties in the examples and application provided. For both utility specifications, we derive travel time reliability ratios and offer a straightforward computation approach using the concepts of $\tau$-deviation and $\tau$-variance. Finally, we use Montreal travel time data for two alternative routes to fit a mixture of gamma distributions and to compare the behavior of the optimal departure time choices and the travel time reliability ratio curves induced by the different utility specifications. -->
<!-- \end{abstract} -->
<!-- \begin{keywords} -->
<!-- scheduling utility, asymmetric loss, expectiles, quantiles, travel time reliability -->
<!-- \end{keywords} -->
<!-- \begin{JEL} -->
<!-- C46, C60, R41 -->
<!-- \end{JEL} -->


# Background

Models of departure time choices often incorporate a scheduling component, where disutility or costs from early or late arrival, weighted by preference parameters, come into play. The majority of these models rely on an asymmetric linear scheduling component (@fosgerau2010, @zhang2016, @guo2017, @li2019, @jin2020). For example, @fosgerau2010 specify the scheduling utility as:

\begin{equation}U_1(d,T) = -\{\alpha T + \beta(d-T)\mathbf 1_{T<d} + \gamma (T-d)\mathbf 1_{T\geq d}\}, (\#eq:u1)
\end{equation}

where $T$ is a random travel time with cumulative distribution function $F$, $0<\beta<\alpha<\gamma$ are the preference parameters, the preferred arrival time is normalized to $0$, and $-d$, $d>0$ is the departure time to choose.
@fosgerau2010 demonstrate that the optimal departure time is equal to $d_1^* = \mu + \sigma F^{-1}\left(\frac{\gamma}{\beta+\gamma}\right)$. This type of utility function assumes strictly increasing cumulative distribution function $F$ of the travel time $T$, such that the inverse $F^{-1}\left(\frac{\gamma}{\beta+\gamma}\right)$ exists for all possible preference parametrizations $\beta$ and $\gamma$. Therefore, this scheduling approach may not be suitable for discrete travel time distributions or mixture distributions with a discrete component as in @depalma2006. In @depalma2006, the authors sensibly model the travel time distribution as a mixture of a continuous part on bad days and a discrete component on good days. For their analysis of risk preferences with information value, they employ classical mean-variance and mean-deviation utility functions, as well as other standard utilities with constant absolute and constant relative risk aversion. Later in the generalized setting, @depalma2012 assume a differentiable utility function, which rules out the specification in \@ref(eq:u1). However, the latter arguably describes the scheduling choice more authentically than the utility specifications in @depalma2006.

In this paper, we propose an alternative specification of the scheduling component. Specifically, we define:
\begin{equation}U_2(d,T) = -\{\alpha T + \beta(d-T)^2\mathbf 1_{T<d} + \gamma (T-d)^2\mathbf 1_{T\geq d}\}. (\#eq:u2)
\end{equation}
The above utility introduces an asymmetric *quadratic* loss on early or late arrival. In this preference formulation, the marginal disutility *increases linearly with the delay magnitude*, potentially describing the preferences of at least some commuters more consistently. Notably, this *continuously differentiable* preference specification fulfills the assumptions of @smith1984 and @daganzo1985 required for the existence and uniqueness of equilibrium in a single bottleneck model. It also satisfies the requirements of @depalma2012 and their equilibrium analysis under risk aversion and information value.

Both preference specifications in \@ref(eq:u1) and \@ref(eq:u2) share the property that the optimal departure time choices correspond to specific *tail indices* of the travel time distribution. For the first specification in \@ref(eq:u1), these are the *quantiles*, and for the second specification in \@ref(eq:u2), these are the *expectiles* of the travel time. The asymmetric quadratic version of the scheduling preferences, and the fact that the solutions to the expected utility maximization problem are quantiles and expectiles (and in general the so-called $L_p$-quantiles) as *the minimizers of expectations in asymmetric* $L_p$*-norms*, seem to have been largely unaddressed explicitly in the previous literature. Moreover, both types of the scheduling preferences are related via the quantile-expectile correspondence (@jones1994), with the second version in \@ref(eq:u2) describing a class of preferences with more favorable properties to the first, as demonstrated below.

In this paper, we analyse and compare the two utility specifications of scheduling preferences: the linear one in \@ref(eq:u1) and the quadratic one in \@ref(eq:u2), with the latter offering advantages over the former. First, we review the existing specification and formally define the new asymmetric quadratic utility in Section 2. In Section 3, we introduce the concepts of quantiles and expectiles as the minimizers of expectations in the respective asymmetric $L_p$-norms, and show that the optimal departure times are the quantiles of $T$ for the linear ($p=1$) and the expectiles of $T$ for the quadratic ($p=2$) case. Furthermore, we link the optimal choices derived from the two utility specifications through the concept of quantile-expectile correspondence and demonstrate that the new asymmetric quadratic class is valid alternative, offering conceptional and computational advantages over the linear asymmetric case in \@ref(eq:u1).  We also derive the travel time reliability ratios to quantify travel time reliability for both utility specifications and propose their estimation using the related concepts of \(\tau\)-deviation and \(\tau\)-variance to complete Section 3.  Using Montreal travel time data, we compare in Section 4 the optimal departure time choices for two routes and the resulting travel time reliability ratios based on a fitted mixture of gamma distributions with two components representing the free-flow and congestion regimes. Finally, we conclude and discuss the implications.

# Asymmetric scheduling preferences

Consider a traveler with a utility function depending on random travel time $T$ with realizations $t\in\mathbb R_+$ and on departure time $-d$ for $d>0,$ with the preferred arrival time normalized to $0$. Assume the following utility function for the traveler, where $\alpha,\beta, \gamma>0$ are preference parameters underlying the relative importance of total travel time, early and late delays respectively:

\begin{align}
U_a(d,T) = -\{\alpha T + \beta(d-T)^a\mathbf 1_{T<d} + \gamma (T-d)^a\mathbf 1_{T\geq d}\}, ~~a\in\{1,2\}.(\#eq:ua)
\end{align} 

For $a=1$ in \@ref(eq:ua), we recover the scheduling approach of @fosgerau2010 and arrive at the utility function already specified in \@ref(eq:u1):

$$U_1(d,T) = -\{\alpha T + \beta(d-T)\mathbf 1_{T<d} + \gamma (T-d)\mathbf 1_{T\geq d}\}.$$

As in @small1982 and @small2015, we require $\gamma>\beta>0$. In this formulation, both early and late arrivals increase the disutility of the traveler in a **linear** manner, with the marginal disutility of early arrival being equal to $\beta$ and the marginal disutility of late arrival being equal to $\gamma$. Note that the utility decrease is asymmetric regarding the type of delay (early or late).   

The asymmetric linear loss may be unrealistic in many situations, as the marginal disutility of early or late delays is constant and does not depend on the magnitude of the delay. For instance, @enide2006  find that extremely long travel times influence significantly the route choice. @vanlint_etal08 advocate approaches to travel time reliability measurement that account for extreme travel times. @sikka_hanley13 find that commuters exhibit high sensitivities towards unreliable routes, on which extremely long travel times are possible. When the marginal disutility increases along with the delay magnitude, asymmetric **quadratic** loss describes such preferences in a way, more consistent with the empirical findings above.  In fact, such a specification of the traveler utility function even simplifies the computation of the optimal departure time, as we show later. The asymmetric quadratic version of $U_a(d,T)$ in \@ref(eq:ua) with $a=2$, mentioned previously in \@ref(eq:u2), reads:

$$U_2(d,T) = -\{\alpha T + \beta(d-T)^2\mathbf 1_{T<d} + \gamma (T-d)^2\mathbf 1_{T\geq d}\}.$$ 

The marginal disutility of an early arrival ($d>t$) becomes $\beta (d-t)$ and the marginal disutility of a late arrival ($d\leq t$) becomes $\gamma (t-d)$. The above formulation of preferences <!--implies higher risk aversion level supported empirically in @boerjesson2012 and--> has the advantage of being differentiable with respect to $d$, which is a necessary condition for the uniqueness of the resulting equilibrium distribution of arrivals in a single bottleneck model (@daganzo1985). Moreover, both utility functions are reformulations of cost functions in departure time choice problems in single bottlenecks as specified by @lindsey2004.

We assume that the traveler maximizes her expected utility $\big(\mathbb E(\cdot)$ denotes the expectation with respect to the distribution of $T$ $\big)$, which corresponds:

- **linear asymmetric case**:
\begin{equation}\mathbb EU_1(d,T) = -\left[\alpha \mathbb ET + \beta\mathbb E\left\{(d-T)\mathbf 1_{T<d} \right\}+ \gamma \mathbb E\left\{(T-d)\mathbf 1_{T\geq d}\right\}\right], (\#eq:eu1)
\end{equation}

- **quadratic asymmetric case**:
\begin{equation}
\mathbb EU_2(d,T) = -\left[\alpha \mathbb ET + \beta\mathbb E\left\{(d-T)^2\mathbf 1_{T<d} \right\}+ \gamma \mathbb E\left\{(T-d)^2\mathbf 1_{T\geq d}\right\}\right]. (\#eq:eu2)
\end{equation}

Both utility formulations fall under the mean-dispersion framework (@engelson2016) with different notions of dispersion used. For $\beta=\gamma$, \@ref(eq:eu1) corresponds to a symmetric mean-absolute deviation utility, and the optimal choice $d^*_1$ corresponds to the median of the travel times. For $\gamma>\beta$ it remains asymmetric, and the second term in the maximized expected utility $\mathbb EU^*_1(d_1^*,T)$ is an asymmetric version of the absolute deviation, termed in @tran2019 as the **$\tau$-deviation** (asymmetrically weighted absolute deviation around the **$\tau$-quantile**). Similarly, for $\beta=\gamma$, \@ref(eq:eu2) becomes $\mathbb EU_2(d,T) = -\left[\alpha \mathbb ET + \beta\mathbb E\left\{(T-d)^2\right\}\right]$,
which is maximized for $d_2^* = \mathbb ET$. Hence, we recover the classical mean-variance utility $\mathbb EU^*_2(d_2^*,T)$ used by @jackson1982. For $\gamma>\beta$ the second term in the maximized expected utility $\mathbb EU^*_2(d_2^*,T)$ is a generalized version of the variance - **the $\tau$-variance** - around a certain tail index - **the $\tau$-expectile**. 



```{r, message=F}
#scheduling utility functions
u<-function(t,d,alpha,beta, gamma, type = 1){
  if(type%in%c(1,2)){
    u<-alpha*mean(t) + beta*mean((d-t)^type*(d>t)) + gamma*mean((t-d)^type*(t>d))
  }
  else {stop("Invalid type argument! Please choose type equal to either 1 or 2.")}
  return(-u)
}
```


```{r, message=F}
#for exponentially distributed $T$
set.seed(123)
t<-rexp(10000,0.01)
d<-seq(50,400,0.05)
type=2

alpha<-2
gamma<-6
beta<-1

uvec1<-uvec2<-rep(NA, length(d))

for(j in 1:length(uvec1)){
    uvec1[j]<-u(t, d=d[j], type=1, alpha=alpha, beta=beta, gamma=gamma)
    uvec2[j]<-u(t, d=d[j], type=2, alpha=alpha, beta=beta, gamma=gamma)
}

# fun<-cbind(d,uvec)
# fun[d>6&d<7,]

```


```{r, message=F}
#compute the optimal departure time
get_opt_departure<-function(t,tau, type=1){
  if(type==2){
    departure_time<-expectreg::expectile(t,tau)
  } else {
    departure_time<-quantile(t,tau)
  }
  names(departure_time)<-ifelse(type==1, "quantile","expectile")
  return(departure_time)
}

tau<-gamma/(gamma+beta)
departure_time<-c(get_opt_departure(t,tau,type=1),get_opt_departure(t,tau,type=2))
#departure_time
```

<!--
```{r figure1, fig.cap="An illustration of the asymmetric linear (left) and the asymmetric quadratic (right) traveler's utility functions (\\(\\beta=1,\\gamma=1.5\\)) with optimal departure times $d^*$ for exponentially distributed travel time \\(T\\) with intensity parameter \\(0.01\\)."}
# #par(mfrow=c(1,2),xpd=T)
# par(lwd=2,mfrow=c(1,2))
# 
# plot(d,uvec1, type="l", axes=F, ylab=bquote(EU[a](d,T)),lty=2, ylim=c(-500,-100))
# lines(d,uvec2/100,lty=1)
# points(d[which.max(uvec2)],max(uvec2)/100,col=2)
# points(d[which.max(uvec1)],max(uvec1),col=2)
# #text(d[which.max(uvec1)],max(uvec1), paste0("d*=",round(d[which.max(uvec1)],2)), pos=3)
# text(d[which.max(uvec1)],max(uvec1), expression(paste(d[1]^"*")), pos=3)
# text(d[which.max(uvec2)],max(uvec2)/100, expression(paste(d[2]^"*")), pos=3)
# axis(1, at=c(50,100,150,200), labels=rep("",4))
# axis(2, at=c(-500,-300,-100), labels=rep("",3))
# legend("topright",lty=c(2,1), lwd=2,legend=c("a=1","a=2"))
# 
# # plot(d,uvec2, type="l",axes=F, ylab=bquote(EU[2](d,T)))
# # points(d[which.max(uvec2)],max(uvec2),col=2)
# # text(d[which.max(uvec2)],max(uvec2), paste0("d*=",round(d[which.max(uvec2)],2)), pos=3)
# # axis(1)
# # axis(2, at=seq(min(uvec2), max(uvec2),length.out=5), labels=rep("",5))
```
-->

# Optimal departure time choice under asymmetric scheduling preferences

In this section, we demonstrate that the optimal departure time is equal to a certain quantile (see @koenker1978) in case of $U_1(d,T)$ and a certain expectile (see @newey1987) for $U_2(d,T)$ of the travel time distribution. The specific quantile or expectile levels depend on the asymmetry parameters ($\beta$ and $\gamma$) of the traveler's utility function. Therefore, we briefly review the concepts of quantiles and expectiles in the following.

## Quantiles and expectiles

Quantiles and expectiles are real numbers that describe the distribution of a real random variable $X$. They generalize the median and the mean, respectively, to their asymmetric versions via the asymmetry index $\tau\in(0,1)$. For a suitable set of such indices $\tau\in(0,1)$, the associated sets of either quantiles $\{q_\tau(X)\}_{\tau\in(0,1)}$ or expectiles $\{e_\tau(X)\}_{\tau\in(0,1)}$ are capable of representing the entire distribution of a random variable.

Both quantiles and expectiles can be viewed as minimizers of the expectations of the corresponding asymmetric norms (see e.g. @tran2019):
\begin{align}
\min_{c\in\mathbb R}\mathbb E_{F_X}||X-c||^a_{a,\tau}, \text{ for } a\in\{1,2\}, (\#eq:asnorm)
\end{align}
where $||x||^a_{a,\tau}=|x|^a\cdot\{\tau\mathbf 1_{x\geq 0}+(1-\tau)\mathbf 1_{x<0}\}$ is the $\ell_a$ asymmetric norm for $x\in\mathbb R$.
That is, the $\tau$-quantile solves: 
\begin{equation}q_\tau(X) = \arg\min_{q\in\mathbb R}\mathbb E_{F_X}||X-q||^1_{1,\tau},(\#eq:quantile)
\end{equation}

whereas the $\tau$-expectile solves:
\begin{equation}
e_\tau(X) = \arg\min_{e\in\mathbb R}\mathbb E_{F_X}||X-e||^2_{2,\tau}.(\#eq:expectile)
\end{equation}
Unlike quantiles which only rely on frequencies, expectiles take into consideration both the frequency of extreme observations and their magnitude.
Moreover, expectiles are uniquely defined for random variables with finite first moments. For quantiles to be unique, a strictly increasing cumulative distribution function is required. For a non-decreasing cumulative distribution function, the quantile function can be defined as $q_\tau(X) = \inf\{x\in \mathbb R: \tau\leq F(x)\}$, which is well-defined. Nevertheless, as shown in the next chapter, all values $\{x\in\mathbb R: \tau= F(x)\}$ induce the same expected scheduling utility level as maximizers of \@ref(eq:eu1) and result in ambiguous choices. The latter fact can create difficulties in treating, for instance, discrete distributions as the examples below show.

### Quantiles and expectiles for different travel time models

Since we are concerned with modelling departure time choice within the framework of quantiles and expectiles, we provide several examples that align with the models of travel time distribution proposed in the literature.

::: {.example #ddqande name="Quantiles and expectiles of a two-value travel time distribution"}

In this example, we consider a discrete two-value travel time distribution. @depalma2006 use this type of distribution to model travel times on an uncertain route in their analysis. Another example is an ideal road link without congestion, where two speed regimes might exist depending on whether the road surface is wet or not (or whether there is fog or not). In this case, $1-p$ could represent the probability of a wet surface or the probability of rain. Yet another scenario where such a two-value discrete distribution may be applicable is bike-sharing. If a commuter uses a bike-sharing station within a short walking distance and finds no bikes available (with probability $1-p$), they would need to account for a longer travel time. Assuming there are no other traffic obstructions, walking and riding a bike at the same speed would result in just two possible travel times, depending on the walking distance in this case.

Consider random travel time $T$ with two values: $t_1$ with probability $p$ and $t_2$, such that $t_2-t_1>0$, with probability $1-p$.The resulting distribution of the travel time is presented in the left panel of Figure \@ref(fig:figex1).
For any $\tau\in [0,p)$ the $\tau$-quantile corresponds to $t_1$; likewise, for $\tau\in (p,1]$ the $\tau$-quantile corresponds to $t_2$. For $\tau=p$, $\mathbb P(T\leq t) = p$ for $t\in[t_1,t_2)$ resulting in a non-unique $\tau$-quantile taking on any value in the range $[t_1,t_2)$. Following the classical definition of the quantile function in @xiao12, where the infimum among the possible values is taken to serve as the unique $\tau$-quantile:

\begin{equation}q_\tau(X) = \inf\{x\in \mathbb R: \tau\leq F(x)\},(\#eq:inf)
\end{equation}

we arrive at $q_p = t_1$.

In case of the expectiles, using formulas (18) and (19) in @holzmann2016 we have (in the following, we use the notation $e_\tau$ for $e_\tau(X)$ and $q_\tau$ for $q_\tau(X)$):

\[e_\tau = \frac{(1-\tau)t_1p+ \tau t_2(1-p)}{(1-\tau)p + \tau(1-p)}.\]

This expression is continuous and strictly increasing in $\tau$ (see Figure \@ref(fig:figex1)).

```{r}
#qbinom(0.6,1,0.5)
```


```{r figex1, out.width="100%", fig.height = 3, fig.width = 10,fig.cap = "Right panel: the considered two-value travel time distribution and the expectile and quantile values (below the $x$-axis) in Example 3.1 for a grid of $\\tau$-values. Left panel: the expectile and the quantile functions for the two-value discrete distribution with varying $p$. "}
t<-10
l<-100
p0<-0.7
p1<-0.8
par(xpd=T,mfrow=c(1,2),mar=c(3,2,2,2))
taus<-c(seq(0.01,0.99,0.01),0.999)
mutau<-((1-taus)*t*p0 + taus*(t+l)*(1-p0))/((1-taus)*p0 + taus*(1-p0))
qtau<-rep(t, length(taus)); qtau[taus>p0]<-t+l
plot(c(t,t+l),c(p0,1-p0),type="l",col=NA,axes=F,ylim=c(0,1),xlim=c(0,120),ylab="",xlab="")
arrows(x0=t,y0=0,x1=t,y1=p0,code=0,lwd=2)
arrows(x0=t+l,y0=0,x1=t+l,y1=1-p0,code=0,lwd=2)
arrows(-10,0,120,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)

#arrows(-0.1,1.03,120,1.03,code=0,lty=2)
#text(-0.1,1,"1",pos=2)
arrows(-0.1,p0,t,p0,code=0,lty=2)
arrows(-0.1,1-p0,t+l,1-p0,code=0,lty=2)
text(-0.1,p0,"p",pos=2)
text(-0.1,1-p0,"1-p",pos=2)
text(t+l,0,bquote(t[2]),pos=1,cex=0.9)
text(t-0.15,0,bquote(t[1]),pos=1,cex=0.9)
#lines(mutau,taus,pch="|",col=4)
#lines(qtau,taus,pch="|",col=2)

points(mutau,rep(-0.1,length(mutau)),pch="|",col=scales::alpha(4,0.6))
text(60,-0.1,bquote(e[tau]),pos=1)
arrows(55,-0.15,40,-0.15,code=2,length=0.1,col=scales::alpha(4,0.6))
arrows(65,-0.15,80,-0.15,code=2,length=0.1,col=scales::alpha(4,0.6))

points(qtau,rep(-0.2,length(qtau)),pch="|",col=scales::alpha(2,0.6))
text(60,-0.2,bquote(q[tau]),pos=1)
#text(68,-0.2,"?",pos=1)
arrows(55,-0.25,40,-0.25,code=2,length=0.1,col=scales::alpha(2,0.6))
arrows(65,-0.25,80,-0.25,code=2,length=0.1,col=scales::alpha(2,0.6))
legend(70,p0,col=c(4,2),lwd=c(1,1),legend=c(bquote(e[tau]),bquote(q[tau])),bty="n")

###################################################################################################
par(xpd=T)
mutau1<-((1-taus)*t*p1 + taus*(t+l)*(1-p1))/((1-taus)*p1 + taus*(1-p1))
qtau1<-rep(t,length(taus)); qtau1[taus>p1]<-t+l

plot(taus,mutau,type="l",ylim=c(0,120), xlim=c(0,1.2),axes=F,xlab="", ylab="",col=4, lwd=2)
lines(taus,mutau1,lty=2,col=4, lwd=2)
lines(taus[taus<p0],qtau[taus<p0],lty=1,col=scales::alpha(2,0.7),lwd=2)
lines(taus[taus>p0],qtau[taus>p0],lty=1,col=scales::alpha(2,0.7),lwd=2)
lines(taus[taus<p1],qtau1[taus<p1],lty=2,col=2,lwd=2)
lines(taus[taus>p1],qtau1[taus>p1],lty=2,col=2,lwd=2)
arrows(-0.01,-5,-0.01,120,code=2,length=0.1)
arrows(-0.1,0.1,1.1,0,code=2,length=0.1)
#legend(0.1,100,lty=c(1,2),legend=c(paste0("p = ",p0),paste0("p = ",p1)),bty="n")
legend(0.1,100,lty=c(1,2),lwd=2,legend=c(bquote(p == p[0]),bquote(p == p[1])),bty="n")

legend(0.1,70,col=c(4,2),lwd=c(1,1),legend=c(bquote(e[tau](tau)),bquote(q[tau](tau))),bty="n")
text(0.5,0,bquote(tau),pos=1)
text(-0.01,60,bquote(e[tau]),pos=2)
text(-0.01,t,bquote(t[1]), pos=2)
text(-0.01,t+l,bquote(t[2]), pos=2)
text(0,0,0,pos=1)
text(1,0,1,pos=1)
points(c(0,1),c(-0.1,0),pch="|",cex=0.5)
points(c(-0.01,-0.01),c(t,t+l),pch="-",cex=1)

arrows(p0,0,p1,0,code=0,lwd=3)
points(c(0,p0),c(-0.1,0),pch="|",cex=0.5)
points(c(0,p1),c(-0.1,0),pch="|",cex=0.5)
text(p0,0,bquote(p[0]),pos=1)
text(p1,0,bquote(p[1]),pos=1)
```

Since $\frac{\partial e_\tau}{\partial p} =(t_1-t_2)\cdot \frac{ \tau (1-\tau)}  {\{\tau+p (1-2\tau )\}^2} <0,$ $e_\tau$ decreases in $p$ or, equivalently, it increases in $1-p$. Note that increasing $p$ from $p_0$ to $p_1$ affects only a small portion of quantiles (with indices $\tau\in[p_0,p_1]$), whereas it impacts all expectiles, as illustrated in the right panel of Figure \@ref(fig:figex1). The expression $\frac{\partial e_\tau}{\partial t_2} =\frac{\tau (1-p)}{(1-\tau)p + \tau(1-p)} >0$ also reveals the impact of increasingly extreme travel times on all expectiles, regardless of the level $\tau$. At the same time, only the upper quantiles for $\tau>p$ are affected.

In summary, expectiles are more sensitive than quantiles to changes in the tail regions of the travel time distribution, making them useful for capturing sensitivity to extremes reported by @enide2006, @vanlint_etal08, and @sikka_hanley13 in empirical analyses.

:::

In the example above, we derive an explicit expression for $e_\tau$. However, this is not always possible, and $e_\tau$ is represented in an implicit functional form based on the first order condition of \@ref(eq:asnorm) for $a=2$:

\begin{align}
\tau\mathbb E\{|Y-e_\tau|\mathbf 1_{Y>e_\tau}\} = (1-\tau)\mathbb E\{|Y-e_\tau|\mathbf 1_{Y\leq e_\tau}\}.(\#eq:etau)
\end{align}

Moreover, as $e_\tau$ is continuous, strictly increasing in $\tau$, and unique for each $\tau\in(0,1)$ for all distributions $F$ with finite expectation (@holzmann2016), there exist an inverse expectile function $\tau(e_\tau)$. This function frequently does have an explicit functional form, making it convenient for analysis. In fact, the inverse expectile function is itself a cumulative distribution function with a density, but it generally differs from the original $F$, as noted by @philipps2022. 

Rearranging \@ref(eq:etau), we get the following expression for the inverse expectile function:

\begin{align}
\tau(e_\tau) &= \frac{\mathbb E\{|Y-e_\tau|\mathbf 1_{Y\leq e_\tau}\}} {\mathbb E\{|Y-e_\tau|\}} = \frac{\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\}}{2\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} - \mathbb E\{(Y-e_\tau)\}}. (\#eq:tau)
\end{align}

Below we provide another example with continuously distributed travel times, where \@ref(eq:tau) provides closed-form expression for the inverse expectile function.

::: {.example #duqande name="Quantiles and expectiles of a mixture of two uniform distribution with disjoint supports"}

Consider a random travel time $T$ that follows a mixture of uniform distributions with ranges $[a_1,a_2]$ and $[a_3,a_4]$, respectively, and with mixing probability $p$. We assume that $a_1<a_2<a_3<a_4$, creating a "gap" in the support of the mixture distribution. For instance, we might consider a road link without congestion that operates under two speed regimes depending on an exogenous event $I$, which takes values ${0,1}$ with probabilities $p$ and $1-p$, respectively. In the context of park-and-ride, this type of travel time distribution could arise due to a specific public service schedule and the resulting waiting time if commuters have to take a later service because of traffic congestion.

Let $F$ denote the cumulative distribution function of $T$. The quantile function for $\tau <p$ is given by:
\[q_\tau = a_1 + \frac{a_2-a_1} p\tau.\]

For $p<\tau$, it is given by: 
\[q_\tau = a_3 + \frac{a_4-a_3}{1-p}(\tau-p).\]
However, when $\tau=p$, any value in  the range $(a_2,a_3)$ is a valid $p$-quantile. Using \@ref(eq:inf), we get $q_p=a_2$.

Starting with \@ref(eq:tau), we compute the inverse expectile function $\tau(e_\tau)$ as follows:

\[
\tau(e_\tau)=\begin{cases}
0, &e_\tau<a_1\\
\frac{-\frac 12 \frac{p}{a_2-a_1}(a_1-e_\tau)^2}{-\frac{p}{a_2-a_1}(a_1-e_\tau)^2    -\frac 12(p(a_1+a_2) + (1-p)(a_3+a_4)) + e_\tau}, & a_1\leq e_\tau<a_2,\\
\frac{\frac 12p\left(a_1 + a_2 - 2e_\tau\right)}{p\left(a_1 + a_2 - 2e_\tau\right)  -\frac 12(p(a_1+a_2) + (1-p)(a_3+a_4)) + e_\tau}, & a_2\leq e_\tau<a_3,\\
\frac{\frac 12 p\left(a_1 + a_2 - 2e_\tau\right)-\frac 12 \frac{1-p}{a_4-a_3}(a_3-e_\tau)^2}{p\left(a_1 + a_2 - 2e_\tau\right)-\frac{1-p}{a_4-a_3}(a_3-e_\tau)^2   -\frac 12(p(a_1+a_2) + (1-p)(a_3+a_4)) + e_\tau}, & a_3\leq e_\tau<a_4,\\
1, &e_\tau\geq a_4.
\end{cases}\]

The resulting expectile functions as functions of $\tau$ for different $p$ are presented in Figure \@ref(fig:figexp1).

```{r}
a1<-10
b1<-20

a2<-30
b2<-110
b22<-140

p0<-0.7
mutaus<-seq(a1,b2,0.5)
mutaus2<-seq(a1,b22,0.5)

p1<-0.8

# tauf<-function(x,a1,b1,a2,b2,p){
#   Exe<-p*(a1+b1)/2+(1-p)*(a2+b2)/2 - x
#   if(x>=a1&x<=b1){
#     tau<- (-1/2*(p/(b1-a1)*(a1-x)^2)) / (-p/(b1-a1)*(a1-x)^2-Exe)
#   }else if(x>b1&x<a2){
#     tau<-(1/2*p*(b1+a1-2*x)) / (p*(b1+a1-2*x) - Exe)
#   } else if (x>=a2&x<=b2){
#     tau<-(1/2*p*(b1+a1-2*x) - 1/2*((1-p)/(b2-a2)*(a2-x)^2)) / (p*(b1+a1-2*x) - ((1-p)/(b2-a2)*(a2-x)^2) - Exe)
#   } else {
#     tau<-NA
#   }
#   return(tau)
# }

tauf<-function(x,a1,b1,a2,b2,p){
  Exe<-p*(a1+b1)/2+(1-p)*(a2+b2)/2 - x
  if(x>=a1&x<=b1){
    tau<- (-1/2*(p/(b1-a1)*(a1-x)^2)) / (-p/(b1-a1)*(a1-x)^2-Exe)
  }else if(x>b1&x<a2){
    tau<-(1/2*p*(b1+a1-2*x)) / (p*(b1+a1-2*x) - Exe)
  } else if (x>=a2&x<=b2){
    tau<-(1/2*p*(b1+a1-2*x) - 1/2*((1-p)/(b2-a2)*(a2-x)^2)) / (p*(b1+a1-2*x) - ((1-p)/(b2-a2)*(a2-x)^2) - Exe)
  } else {
    tau<-NA
  }
  return(tau)
}
taufs<-sapply(mutaus,tauf,a1=a1,b1=b1,a2=a2,b2=b2,p=p0)
mutauss<-approx(taufs, mutaus, xout=taus)

taufs1<-sapply(mutaus,tauf,a1=a1,b1=b1,a2=a2,b2=b2,p=p1)
mutauss1<-approx(taufs1, mutaus, xout=taus)

qtausf<-function(tau,a1,b1,a2,b2,p){
  if(tau<p){
    qtau<-a1+(b1-a1)*(tau/p)
  } else if (tau>p){
    qtau<-a2 +(b2-a2)*(tau /(1-p) - p/(1-p))
  } else {
    qtau<-NA
  }
  return(qtau)
}
qtauss<-sapply(taus,qtausf,a1=a1,b1=b1,a2=a2,b2=b2,p=p0)
qtauss1<-sapply(taus,qtausf,a1=a1,b1=b1,a2=a2,b2=b2,p=p1)

qtauss2<-sapply(taus,qtausf,a1=a1,b1=b1,a2=a2,b2=b22,p=p0)

taufs2<-sapply(mutaus2,tauf,a1=a1,b1=b1,a2=a2,b2=b22,p=p0)
mutauss2<-approx(taufs2, mutaus2, xout=taus)

```



```{r figexp1, out.width="100%",fig.height = 3, fig.width = 10, fig.cap="Left panel: The considered mixture of two uniform distributions in Example 3.2 and the expectile and quantile values (below the $x$-axis) for a grid of $\\tau$-values. Right panel: The inverse quantile and expectile functions for different mixing parameter $p$ and varying right extreme value $a_4$ in Example 3.2."}
par(xpd=T, mfrow=c(1,2), mar=c(3.8,2,1,2))
plot(c(a1,b1),c(p0,p0),type="l",axes=F,ylim=c(0,1.2),xlim=c(0,120),ylab="",xlab="",lwd=2)
lines(c(a2,b2),c(1-p0,1-p0),lwd=2)
arrows(a1,0,a1,p0,code=0,lty=2)
arrows(b1,0,b1,p0,code=0,lty=2)
arrows(a2,0,a2,1-p0,code=0,lty=2)
arrows(b2,0,b2,1-p0,code=0,lty=2)

arrows(-10,0,120,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)

#arrows(-0.1,1,120,1,code=0,lty=2)
#text(-0.1,1,"1",pos=2)

arrows(-0.1,p0,a1,p0,code=0,lty=2)
arrows(-0.1,1-p0,a2,1-p0,code=0,lty=2)

text(-0.1,p0,"p",pos=2)
text(-0.1,1-p0,"1-p",pos=2)

text(a1,0,bquote(a[1]),pos=1)
text(a2,0,bquote(a[3]),pos=1)
text(b1,0,bquote(a[2]),pos=1)
text(b2,0,bquote(a[4]),pos=1)


#lines(mutauss$y,mutauss$x,pch="|",col=4,cex=0.5)
#lines(mutauss1$y,mutauss1$x,pch="|",col=4,cex=0.5,lty=2)

points(mutauss$y,rep(-0.1,length(taus)),pch="|",col=scales::alpha(4,0.4),cex=0.8)
text(60,-0.12,expression(paste(e[tau] ,",", tau %in% "(0,1)")),pos=1)
arrows(55,-0.15,40,-0.15,code=2,length=0.1,col=scales::alpha(4,0.6))
arrows(65,-0.15,80,-0.15,code=2,length=0.1,col=scales::alpha(4,0.6))

#lines(qtauss[taus<p0],taus[taus<p0],pch="|",cex=0.5,col=2)
#lines(c(a2,qtauss[taus>p0]),c(p0,taus[taus>p0]),pch="|",cex=0.5,col=2)

#lines(qtauss1[taus<p1],taus[taus<p1],pch="|",cex=0.5,col=2,lty=2)
#lines(c(a2,qtauss1[taus>p1]),c(p1,taus[taus>p1]),pch="|",cex=0.5,col=2,lty=2)

points(c(a2,qtauss),rep(-0.25,length(taus)+1),pch="|",col=scales::alpha(2,0.4),cex=0.8)
text(60,-0.27,expression(paste(q[tau] ,",", tau %in% "(0,1)\\{p}")),pos=1)
arrows(55,-0.3,40,-0.3,code=2,length=0.1,col=scales::alpha(2,0.6))
arrows(65,-0.3,80,-0.3,code=2,length=0.1,col=scales::alpha(2,0.6))

#text(60,-0.37,bquote(q[p]),pos=1)
#text(67,-0.37," = ?",pos=1)
#legend(50,0.5,col=c(2,4),lwd=c(1,1),legend=c(bquote(tau(q[tau])),bquote(tau(e[tau]))),bty="n")
legend(70,p0,col=c(4,2),lwd=c(1,1),legend=c(bquote(e[tau]),bquote(q[tau])),bty="n")
####################################################################################################
par(xpd=T)
plot(c(a1,b1),c(p0,p0),type="l",axes=F,ylim=c(0,1.2),xlim=c(0,b22+10),ylab="",xlab="",lwd=2,col=NA)
arrows(-10,0,b22+10,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)
text(-0.1,0.5,bquote(tau),pos=2)
text(-0.1,0.04,0,pos=2)
text(-0.1,1,1,pos=2)
points(rep(-0.1,1),c(1),pch="-")
points(c(a1,b1,a2,b2,b22),rep(0,5),pch="|", cex=0.5)
text(a1,0,bquote(a[1]),pos=1)
text(a2,0,bquote(a[3]),pos=1)
text(b1,0,bquote(a[2]),pos=1)
text(b2,0,bquote(a[4]),pos=1)
text(b22,0,bquote(tilde(a)[4]),pos=1)
#
lines(mutauss$y,mutauss$x,pch="|",col=4,cex=0.5,lwd=2)
lines(mutauss1$y,mutauss1$x,pch="|",col=4,cex=0.5,lty=2,lwd=2)
lines(c(mutauss2$y,b22),c(mutauss2$x,1),pch="|",col=4,cex=0.5,lty=3,lwd=2)
#
lines(qtauss[taus<p0],taus[taus<p0],pch="|",cex=0.5,col=2,lwd=2)
lines(c(a2,qtauss[taus>p0]),c(p0,taus[taus>p0]),pch="|",cex=0.5,col=2,lwd=2)
#
lines(qtauss1[taus<p1],taus[taus<p1],pch="|",cex=0.5,col=2,lty=2,lwd=2)
lines(c(a2,qtauss1[taus>p1]),c(p1,taus[taus>p1]),pch="|",cex=0.5,col=2,lty=2,lwd=2)
#
lines(qtauss2[taus<p0],taus[taus<p0],pch="|",cex=0.5,col=2,lty=2,lwd=2)
lines(c(a2,qtauss2[taus>p0]),c(p0,taus[taus>p0]),pch="|",cex=0.5,col=2,lty=3,lwd=2)
#
legend(90,0.5,col=c(2,4),lwd=c(2,2),legend=c(bquote(tau(q[tau])),bquote(tau(e[tau]))),bty="n")
#legend(50,0.5,lty=c(1,2),lwd=c(1,1),legend=c(paste0("p = ",p0),paste0("p = ",p1)),bty="n")
legend(50,0.5,lty=c(1,2,3),lwd=c(2,2,2),legend=c(bquote(p == p[0]),bquote(p == p[1]), bquote(a[4]%up% tilde(a)[4])),bty="n")
```

Note that in this case, all expectiles and quantiles change with $p$ (see the right panel of Figure \@ref(fig:figexp1)). But what happens if we increase $a_4$ to extend the extreme right end of the travel time? As in the previous example, all expectiles are affected, but only the upper quantiles ($\tau>p$) change.

In general, for mixtures of $m$  disjoint (sorted) uniforms holds with mixing parameter vector $\mathbf p=(p_1,\ldots,p_m)^\top$ where $p_m=1-\sum_{i=1}^{m-1}p_i$ and support edges $a_1<a_2<\ldots<a_{m+1}$:

\[\tau(e_\tau) = 
\begin{cases}
0,&e_\tau<a_1,\\
\frac{-\frac 12\frac{p_1}{a_2-a_1}(a_1-e_\tau)^2}  {-\frac{p_1}{a_2-a_1}(a_1-e_\tau)^2- \sum_{j=1}^mp_j\frac{a_{j+1}+a_j}2 +e_\tau} ,&a_1\leq e_\tau< a_2,\\
\frac{\frac 12\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac 12 \cdot \frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2}  {\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2- \sum_{j=1}^mp_j\frac{a_{j+1}+a_j}2 +e_\tau} ,&a_i\leq e_\tau< a_{i+1},i=2,\ldots, m\\
1, &e_\tau\geq a_{m+1}.
\end{cases}\]

:::

In Example \@ref(exm:duqande), we used a mixture of two continuous distributions to model travel time $T$. However, mixture models with both discrete and continuous components were considered in the literature as well. For instance, to model urban arterial roads, @zheng_fangfang2017 distinguish two regimes: undersaturated and oversaturated conditions. Under oversaturated conditions, the authors model the probability function of a delay as a mixture of several box shaped functions with bounded supports, which may not overlap as in Example \@ref(exm:duqande). The overall delay distribution in @zheng_fangfang2017 is composed of a mixture of Dirac delta functions on a fixed free-flow time and several uniform delay distributions with bounded supports representing the effects of traffic lights, traffic control or similar conditions. As mentioned in @zheng_fangfang2017, the point mass at $a_0$ can be substituted by a distribution centered at $a_0$, since different vehicle or driver types may exhibit slightly varying free-flow times. 

Within our framework, one can use a mixture of any appropriate distributions instead of the uniform mixture components. For instance, @jabari2019 use mixture of gamma distributions for travel time modelling. In this case, $\tau(e_\tau)$ has no closed-form expression; however, numeric computation based on Equation \@ref(eq:tau) is still feasible (see @daouia_etal24). For a given distribution, quantiles and expectiles can be obtained by Monte-Carlo approximation, where the sample counterparts, $\hat q_\tau(X)$ and $\hat e_\tau(X)$, of the population $\tau$-quantile (defined in \@ref(eq:quantile)) and $\tau$-expectile (defined in \@ref(eq:expectile)) are computed as plug-in estimators based on the empirical distribution function:

\begin{align}
\hat q_\tau(X) = \arg\min_{q\in\mathbb R}\sum_{i=1}^n||x_i-q||^1_{1,\tau}, (\#eq:q)
\end{align}
and

\begin{align}
\hat e_\tau(X) = \arg\min_{e\in\mathbb R}\sum_{i=1}^n||x_i-e||^2_{2,\tau}. (\#eq:e)
\end{align}

In this formulation, both are asymmetric versions of *M-estimators* and *M-quantiles* with the corresponding properties as consistency and, under some more restrictive assumptions as finite second moment and continuous $F$, asymptotic normality (@holzmann2016, @abdous1995, @breckling1988). Moreover, as @abdous1995 note, sample expectile estimators are *more efficient* than sample quantiles.

In the following, we consider another example, where a mixture of gamma distributions id used to model travel time.

::: {.example #qdzheng name="Quantiles and expectiles of travel time distribution with continuous gamma components"}

Consider now a travel time distribution where there is a certain probability $0<p_0<1$ that the free-flow travel time follows a gamma distribution with parameters $k_f>0$ (shape) and $\theta_f>0$ (scale) is attained. At the same time, congestion conditions occur with  probability $p$, and the travel time distribution under congestion is represented by another gamma distribution with higher mean and variance, parametrized by $k_d>0$ and $\theta_d>0$, such that $k_f\theta_f<k_d\theta_d$ and $k_f\theta^2_f<k_d\theta^2_d$.

To illustrate, we set $k_f=10$, $\theta_f=0.5$, $k_c=20$, $\theta_c=2$. This corresponds to a free-flow mean travel time of $5$ minutes with a standard deviation of $\approx 1.58$ minutes, and a mean congestion travel time of $10$ minutes with a standard deviation of $\approx 8.94$ minutes.  The quantiles and expectiles are obtained by Monte-Carlo approximation (@daouia_etal24).


```{r}
kf<-10
tf<-0.5

kd<-20
td<-2

td2<-3

p<-0.7
p1<-0.8

xx<-seq(0,120,0.1)
mycol1<-mycol2<-1

set.seed(123)
N=10^5
us<-runif(N)
times<-times1<-times2<-rgamma(N, shape=kf,scale=tf)
times[us>p]<-rgamma(sum(us>p), shape=kd,scale=td)
#p|^
times1[us>p1]<-rgamma(sum(us>p1), shape=kd,scale=td)
#mu|^
times2[us>p]<-rgamma(sum(us>p), shape=kd,scale=td2)

taus<-seq(0,1,0.01)
qtaus<-quantile(times,taus)
mutaus<-expectreg::expectile(times, taus)

qtaus1<-quantile(times1,taus)
mutaus1<-expectreg::expectile(times1, taus)

qtaus2<-quantile(times2,taus)
mutaus2<-expectreg::expectile(times2, taus)
```

```{r figexp3, out.width="100%",fig.height = 3, fig.width = 10, fig.cap="Left panel: The considered mixture of two gamma distributions in Example 3.3. Right panel: The inverse quantile and expectile functions for different parameter values for $p$ and $\theta$ in Example 3.3."}
par(mfrow=c(1,2), mar=c(2,2,2,2))

par(xpd=F)
plot(xx,dgamma(xx, shape=kf,scale=tf), type="l", col=mycol1, xlab="", ylab="",axes=F, xlim=c(0,80), ylim=c(0,0.4))
lines(xx,dgamma(xx, shape=kd,scale=td), type="l", col=mycol2)
lines(xx,dgamma(xx, shape=kd,scale=td2), type="l", col=mycol2, lty=3)

text(20,0.2, "free flow",col=mycol1, pos=3)
text(40,0.2, bquote(Gamma(k[f],theta[f])),col=mycol1, pos=3)
arrows(20,0.2,10,0.15,code=2,col=mycol1,length=0.1)

text(30,0.1, "congestion",col=mycol2, pos=3)
text(20,0.05, bquote(Gamma(k[c],theta[c])),col=mycol2, pos=3)
arrows(30,0.1,35,0.05,code=2,col=mycol2,length=0.1)

text(55,0.07, bquote(Gamma(k[c],tilde(theta)[c])),col=mycol2, pos=3)
arrows(30,0.1,55,0.04,code=2,col=mycol2,length=0.1)

par(xpd=T)
arrows(-2,0,85,0,code=2,length=0.1)
arrows(0,-0.01,0,0.4,code=2,length=0.1)
#arrows(kf*tf,-0.01,kf*tf,dgamma(kf*tf,shape=kf,scale=tf), lty=2, col="gray44",code=0)
#arrows(kd*td,-0.01,kd*td,dgamma(kd*td,shape=kd,scale=td), lty=2, col="gray44",code=0)
text(40,0,"t",pos=1)
text(0,0.2,"f(t)",pos=2)

########################################################################################


plot(mutaus,taus,type="l",axes=F,ylim=c(0,1.1),xlim=c(0,110),ylab="",xlab="",lwd=2,col=4)
lines(qtaus, taus, col=2, lwd=2)

arrows(-10,0,120,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)
points(c(0,p,p1),c(1,p,p1),pch="-")

text(-0.1,c(p), bquote(p[0]),pos=2)
text(-0.1,c(p1), bquote(p[1]),pos=2)
text(-0.1,c(1,0.04),c("1","0"),pos=2)
text(0,0.5,bquote(tau),pos=2)

lines(mutaus1,taus,col=4,lty=2, lwd=2)
lines(qtaus1,taus,col=2,lty=2,lwd=2)

lines(mutaus2,taus,col=4,lty=3, lwd=2)
lines(qtaus2,taus,col=2,lty=3, lwd=2)


legend(60,0.5,col=c(2,4),lwd=c(2,2),legend=c(bquote(tau(q[tau])),bquote(tau(e[tau]))),bty="n")
legend(20,0.5,lty=c(1,2,3),lwd=c(2,2,2),legend=c(bquote(p[]==p[0]),bquote(p[]==p[1]), bquote(theta[c]%up%tilde(theta)[c])),bty="n")
text(55,0,"t",pos=1)

```

In this example, the mixture distribution has a continuous density, and both the (inverse) quantile and the expectile functions are smooth. Nevertheless, in low probability regions, the quantile function is rather "flat", exhibiting a drastic change in value for a small change in $\tau$. As in the previous example, we observe similar effects resulting from changing the mixture parameter $p$ and extending the right tail probability of the congestion state (by increasing the scale $\theta$). Only the upper quantiles ($\tau>p$) respond to changes in the congestion distribution; there is a clear distinction between the effects of changing $p$ the upper (high impact) and lower quantiles (low impact). In contrast, the effects on the expectiles are more evenly distributed.

:::

### Properties of quantiles and expectiles

Being quantile-alike tail indices, expectiles share some properties of quantiles, such as location and scale equivariance.  To be able to compare both tail indices later in the analysis, we provide their important properties below. Moreover, there exists a correspondence between quantiles and expectiles, which allows to interchange their use. We summarize the properties in the upcoming propositions.


::: {#propprops .proposition name="Location and scale equivariance of quantiles and expectiles"}
Let $Y\in\mathbb R$ be a random variable with finite expectation; then, for $\tau  \in (0,1)$ and $s>0$:

- $q_\tau(sY+m) = sq_\tau(Y) + m$ (follows from location and scale equivariance of the quantile loss function) and

- $e_\tau(sY+m)=se_\tau(Y) + m$ (Theorem 1 in @newey1987).

:::

The properties above are useful for analysing the role of the mean and the variance of travel time distribution for optimal departure time plans. 

Another useful property is the existence of the correspondence between (well-defined) quantiles and expectiles (see @jones1994, @yao1996 and @waltrup2015) of a distribution. 


::: {#corr .proposition name="Quantile-expectile correspondence"}

For each well-defined $\tau_1$-quantile, there exists $\tau_2(\tau_1)\in(0,1)$ such that $q_{\tau_1}(Y) = e_{\tau_2(\tau_1)}(Y).$
The correspondence function between quantiles and expectiles of a random Variable $T\in \mathbb R$ with distribution function $F$, $\tau_2(\tau_1):(0,1)\rightarrow(0,1)$ is given by:
\[\tau_2 (\tau_1) = \frac{-q_{\tau_1}\tau_1 + G(q_{\tau_1})}{-\mathbb EY + 2G(q_{\tau_1})+q_{\tau_1}(1-2\tau_1)},\]
where $G(q) = \int_{-\infty}^qt~dF(t)$ is the partial moment function.



:::
```{proof}
The proof follows @yao1996 who proof the result in a regression context. 

For any distribution $F$ with finite mean, the expectile function $\tau_2\rightarrow e_{\tau_2}(F)$ is continuos, strictly increasing and has range $\{y\in\mathbb R: 0<F(y)<1\}$. So, for each well defined quantile $q_{\tau_1}=F^{-1}(\tau_1)$ there exists $\tau_2$ such that: 
$$q_{\tau_1}(F) = e_{\tau_2}(F).$$

Following @yao1996 and using the following identity for $\tau_2$:
$$\tau_2 = \frac{\mathbb E(|Y-e_{\tau_2}|\mathbf 1_{Y\leq e_{\tau_2}})}{\mathbb E(|Y-e_{\tau_2}|\mathbf 1_{Y\leq e_{\tau_2}}) + \mathbb E(|Y-e_{\tau_2}|\mathbf 1_{Y> e_{\tau_2}})},$$

we get:
\begin{align*}\tau_2 (\tau_1) &= \frac{\mathbb E(|Y-q_{\tau_1}|\mathbf 1_{Y\leq q_{\tau_1}})}{\mathbb E(|Y-q_{\tau_1}|\mathbf 1_{Y\leq q_{\tau_1}}) + \mathbb E(|Y-q_{\tau_1}|\mathbf 1_{Y> q_{\tau_1}})},\\
&= \frac{-\mathbb E(Y\mathbf 1_{Y\leq q_{\tau_1}})+q_{\tau_1}\tau_1}{\mathbb E(Y\mathbf 1_{Y\leq q_{\tau_1}})-q_{\tau_1}\tau_1 + \mathbb E(Y\mathbf 1_{Y> q_{\tau_1}})-q_{\tau_1}(1-\tau_1)},\\
&= \frac{-\mathbb E(Y\mathbf 1_{Y\leq q_{\tau_1}})+q_{\tau_1}\tau_1}{\mathbb EY - 2\mathbb E(Y\mathbf 1_{Y\leq q_{\tau_1}})-q_{\tau_1}(1-2\tau_1)}.
\end{align*}

Rewriting $\mathbb E(Y\mathbf 1_{Y\leq q}) = G(q)$, we obtain:

$$\tau_2 (\tau_1) = \frac{-q_{\tau_1}\tau_1 + G(q_{\tau_1})}{-\mathbb EY + 2G(q_{\tau_1})+q_{\tau_1}(1-2\tau_1)}.$$
```


Using the above correspondence between quantiles and expectiles, a comparison of the optimal plans for the two parameterizations of the utility function is straightforward.

::: {.example #corrqe name="Correspondence between quantiles and expectiles"}
Consider $T$ with the uniform mixture distribution as in Example \@ref(exm:duqande). The correspondence function between the associated $\omega$-quantile and the $\tau$-expectile of $T$ $\tau(\omega):(0,1)\setminus\{`r paste0(round(p0,2))`\}\rightarrow(0,1)$ is given by:

$$\tau(\omega)=\begin{cases}
\frac{-\omega q_\omega+ \frac 12 \frac p{a_2-a_1}(q_\omega^2-a_1^2)}{-\frac{p(a_1+a_2)}{2}-\frac{(1-p)(a_3+a_4)}{2} +\frac p{a_2-a_1}(q_\omega^2-a_1^2) + (1-2\omega)q_\omega},&q_\omega= a_1 + \frac{a_2-a_1} p\omega, \omega <p\\
\frac{-\omega q_\omega(T) + \frac 12 p(a_1+a_2) + \frac 12 \frac {1-p}{a_4-a_3}(q_\omega^2-a_3^2)}{-\frac{(1-p)(a_3+a_4)}{2} + \frac{p(a_1+a_2)}2 + \frac {1-p}{a_4-a_3}(q^2-a_3^2) + (1-2\omega)q_\omega},&q_\omega = a_3 + \frac{a_4-a_3}{1-p}(\omega-p), p<\omega
\end{cases}$$

and is shown in Figure \@ref(fig:figcor).

:::

```{r}

a1<-10
b1<-20

a2<-30
b2<-110

p0<-0.8


n=10000
u<-runif(n)
t1<-runif(n,a1,b1)
t1[u>p0]<-runif(sum(u>=p0),a2,b2)
t<-t1
tauts<-c(seq(0.01,0.99,0.01),0.995)
expectiles<-expectreg::expectile(t,tauts)
alphas<-sapply(expectiles,function(x,q){sum(x<q)/length(x)},x=t)
ind<-c(as.numeric(names(alphas))<=0.47|as.numeric(names(alphas))>0.8)
#linear interpolation
taus<-c(0.01,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99)
tau_new = approx(tauts[ind], alphas[ind], xout=taus)



tau_omega<-function(w,a1,a2,a3,a4,p){
  et<-0.5*p*(a1+a2) + 0.5*(1-p)*(a3+a4)
  if(w<p){
    qw<-a1+(a2-a1)/p*w
    gq<-0.5*p/(a2-a1)*(qw^2-a1^2)
    tw<-(-w*qw + gq) / (-et+2*gq+(1-2*w)*qw )
  } else if (w>p){
    qw<-a3+(a4-a3)/(1-p)*(w-p)
    gq<-0.5*p*(a1+a2)+0.5*(1-p)/(a4-a3)*(qw^2-a3^2)
    tw<-(-w*qw + gq) / (-et+2*gq+(1-2*w)*qw )
  } else{
    tw<-NA
  }
  return(tw)  
}

omega<-c(0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.85,0.95,0.99)
tomega<-sapply(omega, tau_omega, a1=a1,a2=b1,a3=a2,a4=b2,p=p0)
w<-seq(0.01,0.99,0.001)
tw<-sapply(w, tau_omega, a1=a1,a2=b1,a3=a2,a4=b2,p=p0)
#cbind(tauts,alphas)
alphas[!ind]<-NA; tauts[!ind]<-NA
alphas[as.numeric(names(alphas))==0.47]<-0.89999
```


```{r figcor, out.width="80%",  fig.height = 3, fig.width = 10,fig.cap="The quantile-expectile correspondence for the mixture of two uniform distributions in Example 3.4 for various quantile and expectile levels and $p=0.8$."}
#par(mar=c(2.6,2.5,1,1), mfrow=c(1,2))
par(mar=c(3,3,1,1), mfrow=c(1,2))
par(xpd=T)
cexp = 0.6
cexpt = 1
plot(alphas,tauts,type="l",axes=F,col=NA,
     ylim=c(-0.1,1.05),xlim=c(-0.1,1.1))
for(i in c(3,5:11)){
  arrows(omega[i],0,omega[i],tomega[i],lty=2, col=2,code=0)
  arrows(0,tomega[i],omega[i],tomega[i],lty=2, col=4,code=0)
  
  text(omega[i], 0,round(omega[i],2),col=2,pos=1, cex=cexp)
  text(0,tomega[i]+0.01, round(tomega[i],2),col=4,pos=2,cex=cexp)
}
i=4
  arrows(omega[i],0,omega[i],tomega[i],lty=2, col=2,code=0)
  arrows(0,tomega[i],omega[i],tomega[i],lty=2, col=4,code=0)
  
  text(omega[i], 0,round(omega[i],2),col=2,pos=1, cex=cexp)
  text(-0.07,tomega[i]+0.01, round(tomega[i],2),col=4,pos=2,cex=cexp)

i=2
 arrows(omega[i],0,omega[i],tomega[i],lty=2, col=2,code=0)
  arrows(0,tomega[i],omega[i],tomega[i],lty=2, col=4,code=0)
  
  text(omega[i], 0,round(omega[i],2),col=2,pos=1, cex=cexp)
  #text(-0.05,tomega[i]+0.01, round(tomega[i],2),col=4,pos=2,cex=cexp)

i=12
 arrows(omega[i],0,omega[i],tomega[i],lty=2, col=2,code=0)
  arrows(0,tomega[i],omega[i],tomega[i],lty=2, col=4,code=0)
  
  text(omega[i]+0.03, -0.001,round(omega[i],2),col=2,pos=1, cex=cexp)
  text(-0.05,tomega[i]+0.06,round(tomega[i],4),col=4,pos=2,cex=cexp)

par(xpd=T)
arrows(p0,-0.05,p0,1,col="gray44",code=0,lty=2)
#
text(p0-0.2,0.7,bquote(omega==p),col="gray44",pos=3, cex=cexpt)
arrows(0.7,0.72,0.79,0.5,code=2,length=0.1,col="gray44", angle=15)
#
#points(w, tw)
indna<-which(is.na(tw))
lines(w[1:min(indna)],tw[1:min(indna)],lwd=2)
lines(w[max(indna):length(w)],tw[max(indna):length(w)],lwd=2)
#axis(1,at=c(0,0.25,0.5,0.75,1))
#axis(2,at=c(0,0.25,0.5,0.75,1))
arrows(-0.1,0,1.1,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)
text(c(0,0,0),c(-0.07,0.5,1.06),c(0,0.5,1),pos=2, cex=cexpt)
text(c(0.5,1),c(-0.1,-0.05),c("",1),pos=1, cex=cexpt)
points(c(0,0),c(0.5,1), pch="-")
points(c(0.5,1),c(0,0),pch="|",cex=0.5)
par(xpd=T)
text(0.5,-0.2,bquote(omega), cex=cexpt)
text(-0.2,0.5,bquote(tau(omega)),cex=cexpt)

############################################################################################
plot(alphas,tauts,type="l",axes=F,col=NA,
     ylim=c(-0.1,1.1),xlim=c(-0.1,1.1))
for(i in c(1:5,12)){
  arrows(0,tau_new$x[i],tau_new$y[i],tau_new$x[i],lty=2, col=4,code=0)
  arrows(tau_new$y[i],0,tau_new$y[i],tau_new$x[i],lty=2, col=2,code=0)
  text(0,tau_new$x[i], round(tau_new$x[i],2),col=4,pos=2, cex=cexp)
  text(tau_new$y[i], 0,round(tau_new$y[i],2),col=2,pos=1,cex=cexp)
}
i=13
 arrows(0,tau_new$x[i],tau_new$y[i],tau_new$x[i],lty=2, col=4,code=0)
  arrows(tau_new$y[i],0,tau_new$y[i],tau_new$x[i],lty=2, col=2,code=0)
  text(0,tau_new$x[i], round(tau_new$x[i],2),col=4,pos=2, cex=cexp)
  text(tau_new$y[i], 0.04,round(tau_new$y[i],2),col=2,pos=1,cex=cexp)

par(xpd=T)
arrows(p0,-0.05,p0,1,col="gray44",code=0,lty=2)
#
text(p0-0.2,0.7,bquote(omega==p),col="gray44",pos=3,cex=cexpt)
arrows(0.7,0.72,0.79,0.5,code=2,length=0.1,col="gray44", angle=15)
#
#points(w, tw)
indna<-which(is.na(tw))
lines(w[1:min(indna)],tw[1:min(indna)], lwd=2)
lines(w[max(indna):length(w)],tw[max(indna):length(w)],lwd=2)
#axis(1,at=c(0,0.25,0.5,0.75,1))
#axis(2,at=c(0,0.25,0.5,0.75,1))
arrows(-0.1,0,1.1,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)
text(c(0,0,0),c(-0.07,0.5,1.1),c(0,0.5,1),pos=2)
text(c(0.5,1),c(0,0),c("",1),pos=1)
points(c(0,0),c(0.5,1), pch="-")
points(c(0.5,1),c(0,0),pch="|",cex=0.5)
par(xpd=T)
text(0.5,-0.2,bquote(omega))
text(-0.2,0.5,bquote(tau(omega)))
```

An estimate for the correspondence function can be obtained following the procedure of @taylor2008, who constructs the empirical cumulative distribution function by counting the observations below the estimated expectile for each of the $\tau$-levels, such that for each $\tau$ there is a corresponding estimate of the quantile index $\omega$. One can then interpolate linearly between the resulting points to obtain $\hat\tau(\omega)$.

Therefore, any quantile is also an expectile via the quantile-expectile correspondence. Since expectiles are uniquely defined for any distribution with a finite mean and do not require invertibility of the cumulative distribution function, they are a well-defined alternative to quantiles. This is particularly beneficial for discrete travel time distributions, continuous mixtures with non-overlapping supports, or mixtures of discrete and continuous components.

## Quantiles and expectiles of travel time distribution as maximizers of $U_1(d,T)$ and $U_2(d,T)$

Now we come back to our traveler's utility function in the asymmetric linear and quadratic versions. The following proposition connects the optimal departure times to quantiles and expectiles of travel time distribution.

::: {#proputil .proposition name="Optimal departure time plans"}
Let $U_a(d,T), a\in\{1,2\}$ specified in \@ref(eq:ua) be the traveler's utility function with $0<\beta_a<\alpha_a<\gamma_a$ fixed. Let  $T$ be a random travel time with distribution function $F$. Then, optimal departure time $d_a^*$ corresponds to:

- the $\tau_1$-quantile $q_{\tau_1}(T)$ of $F$ in case of $U_1(d,T)$, 

- the $\tau_2$-expectile $e_{\tau_2}(T)$ of $F$ in case of $U_2(d,T)$,

with $\tau_a=\frac{\gamma_a}{\gamma_a+\beta_a}$ and $a\in\{1,2\}$. Alternatively, we can express the ratio $\frac{\gamma_a}{\beta_a}$ in terms of $\tau_a$ as $\frac{\gamma_a}{\beta_a} = \frac{\tau_a}{1-\tau_a}.$
:::

```{proof}

Rewrite $\mathbb EU_a(d,T)$ as:
\[\mathbb EU_a(d,T) = -\left[\alpha_a \mathbb E(T^a) + (\gamma_a+\beta_a)\mathbb E\left\{\frac{\beta_a}{\gamma_a+\beta_a}(d-T)^a\mathbf 1_{T<d}+ \frac{\gamma_a}{\gamma_a+\beta_a}(T-d)^a\mathbf 1_{T\geq d}\right\}\right].\]

Setting $\tau_a=\frac{\gamma_a}{\gamma_a+\beta_a}$, we get:

\begin{align}
\mathbb EU_a(d,T) &= -\left[\alpha_a \mathbb E(T^a) + (\gamma_a+\beta_a)\mathbb E\left\{(1-\tau_a)(d-T)^a\mathbf 1_{T<d}+ \tau_a(T-d)^a\mathbf 1_{T\geq d}\right\}\right]\nonumber\\
&= -\left(\alpha_a \mathbb E(T^a) + (\gamma_a+\beta_a)\mathbb E\left[|T-d|^a\{(1-\tau_a)\mathbf 1_{T<d}+ \tau_a\mathbf 1_{T\geq d}\right\}\right)\nonumber\\
&= -\alpha_a \mathbb E(T^a) - (\gamma_a+\beta_a)\mathbb E||T-d||_{a,\tau_a}^a. (\#eq:as)
\end{align}
That is, maximizing $\mathbb EU_a(d,T)$ over $d\in\mathbb R$ is equivalent to minimizing $\mathbb E||T-d||_{a,\tau_a}^a$ resulting in $d_1^*=q_{\tau_1}(T)$ in case $a=1$ and $d_2^*=e_{\tau_2}(T)$ in case $a=2$.


```


Proposition \@ref(prp:proputil) can be extended to a general setting with:
\begin{align}
\mathbb E U_p(d,T) = -\alpha_p \mathbb E(T) - (\gamma_p+\beta_p)\mathbb E||T-d||_{p,\tau}^p, 1\leq p <\infty(\#eq:up)
\end{align} 
and thus incorporates asymmetric $L_p$-loss on the early and late delays.

The optimal departure time, $d_p^*$, in this generalized setting corresponds to the so-called $L_p$-quantile introduced in @chen96 as a result of minimizing $\mathbb E||T-d||_{p,\tau_p}^p$ for $0\leq\tau_p\leq 1$ and $1\leq p <\infty$.

$U_p(d,T)$ generalizes the classical asymmetric linear scheduling utility to a richer class of preference functions, where an additional parameter $p$ can be used to adjust commuters' aversions to delays. In our further analysis, we focus on $p\in \{1,2\}$ and the comparison of the resulting preferences. 


***

Given the optimal choice ($d_1^*= q_{\tau_1}(T)$ or $d_2^*= e_{\tau_2}(T)$), the second term in \@ref(eq:as) corresponds to the asymmetric version of the absolute deviation ($a=1$) and variance ($a=2$) of random travel times, respectively. As a result, we get the $\tau$-deviation and the $\tau$-variance of $T$, denoted as $Dev_\tau(T)$ and $Var_\tau(T)$, respectively. The notions of $Dev_\tau(T)$ and $Var_\tau(T)$ were introduced in @tran2019 and are defined as:

\begin{equation}
Dev_\tau(T) = \mathbb E ||T-q_{\tau_1}(T)||_{1,\tau_1} (\#eq:tdev)
\end{equation}

and 
\begin{equation}
Var_\tau(T) = \mathbb E ||T-e_{\tau_2}(T)||^2_{2,\tau_2}. (\#eq:tvar)
\end{equation}

Furthermore, using the location scale invariance of quantiles in Proposition \@ref(prp:propprops) for $a=1$, we get the well-known result of @fosgerau2010, where the optimal departure time $d_1^* = \mu + \sigma F^{-1}\left(\frac{\gamma_1}{\beta_1+\gamma_1}\right)$ with $F$ being the cumulative distribution function of the standardized travel time. The result for $a=2$ is new. Proposition \@ref(prp:proputil) generalizes, therefore, the result of @fosgerau2010 to $a\in\{1,2\}$ and provides a unified understanding of how the considered type of utility function is linked to the distributional properties of travel time $T$. 

Note that, although unique quantiles can be defined using \@ref(eq:inf), in utility terms commuters are *indifferent* between departure time in the respective quantile value ranges. That is, the resulting departure time choice is still not well-defined for some levels $\tau$. In the same time, the expectiles are uniquely defined for all $\tau\in (0,1)$ for any distribution with finite mean. Moreover, since all expectiles depend on the whole distribution, they are all responsive to changes in distributional parameters as opposed to quantiles as shown in the examples above. 

As mentioned previously, there exist the correspondence function between quantiles and expectiles of a given distribution, which maps each well-defined quantile $q_{\alpha}(T)$ to an expectile $e_{\tau(\alpha)}(T)$. Therefore, the expected utility maximization in \@ref(eq:eu2) produces the same choices for suitably chosen preference parameter $\gamma/\beta$, as shown in proposition \@ref(prp:proputil2) below. Moreover, the asymmetric quadratic preference class is richer than the asymmetric linear one, as it delivers well-defined solutions for every combination of scheduling preference parameters not only for distributions of $T$ with strictly increasing $F$ but also for discrete distributions or distribution with discontinuous support (see examples \@ref(exm:ddqande) and \@ref(exm:duqande)).

::: {#proputil2 .proposition name="Correspondence between $U_1$- and $U_2$-based choices"}
Let $U_1(d,T)$ be the traveler's utility function with known $\gamma_1>\beta_1>0$. Let  $T$ be a random travel time with distribution function $F$ and a finite mean. Then, for each $\tau_1 = \frac{\gamma_1}{\beta_1+\gamma_1}$, where $F$ is invertible, there exist $\tau_2$ and $\gamma_2>\beta_2>0$ such that maximizing $\mathbb E U_1(d,T)$ with respect to $d$ is equivalent to maximizing $\mathbb E U_2(d,T)$ with respect to $d$, and thus both utilities <!--represent the same scheduling preferences as they--> produce the same choices in the expected utility sense.
<!--and thus maximization of both expected utilities produce the same choices.-->

:::

```{proof}

Using Proposition \@ref(prp:proputil), the optimal departure plan $d_1^*$ for $U_1(d,T)$ satisfies:

\[d_1^* = \arg\min_{d\in \mathbb R^+}\mathbb E\left(||T-d||_{1,\tau_1}\right),\]

which corresponds to the $\tau_1$-quantile of $T$ for $\tau_1=\frac{\gamma_1}{\beta_1+\gamma_1}$. Wenn $F$ is invertible in $\tau_1$, there exist a map $\tau_2\equiv\tau_2(\tau_1)$ such that for the $\tau_2$-expectile, $e_{\tau_2}$, holds $e_{\tau_2} = q_{\tau_1}$ (Propositon \@ref(prp:corr)). That is:

\[d_1^* = \arg\min_{d\in \mathbb R^+}\mathbb E\left(||T-d||_{1,\tau_1}\right) = \arg\min_{d\in \mathbb R^+}\mathbb E\left(||T-d||_{2,\tau_2}^2\right) = d_2^*.\]

The parameters $\gamma_2>\beta_2>0$ are related as:

\begin{equation}\frac{\gamma_2}{\beta_2+\gamma_2} = \tau_2(\tau_1) = \tau_2\left(\frac{\gamma_1}{\beta_1+\gamma_1}\right), (\#eq:tcor)
\end{equation}

or \(\frac{\gamma_2}{\beta_2} = \frac{\tau_2}{1-\tau_2},\) where $\tau_2\equiv \tau_2\left(\frac{\gamma_1}{\beta_1+\gamma_1}\right)$ is the quantile-expectile correspondence relation.

```

In summary, the considered scheduling utility functions share the property that the maximizers of the resulting expected utilities are the tail indices (the $\tau$-quantile or the $\tau$-expectile) of the random travel time, where the index $\tau$ depends on the preference parameters ($\tau=\gamma/(\beta+\gamma)$). Moreover, via the quantile-expectile correspondence, a maximizer of $\mathbb EU_2(d,t)$ is also a maximizer of $\mathbb EU_1(d,t)$ for some suitable preference transformation $\tilde\gamma/\tilde \beta$ obtained by the inversion of \@ref(eq:tcor) if the relevant $\tau_1$-quantile is unique. Hence, the choices induced by maximizing \@ref(eq:eu1) build a subset of the choices induced by \@ref(eq:eu2), and the latter enables a richer preference representation.

## Analysing the effects of availability, accessibility and extreme travel times under $U_1(T,d)$ and $U_2(T,d)$

In Example \@ref(exm:ddqande), we used a two-value travel time distribution and discussed its applicability for modeling departure time choice in the context of a bike rental station, where a bike is available with probability $p$. If there is an available bike, the total travel time is $t_1$, otherwise a longer travel time, $t_2$, must be taken into account.

In this section, we analyze the effects of increasing availability (by increasing $p=\mathbb P(T=t_1)$) and improving accessibility (by decreasing $t_2$). To derive the time-saving effects for the two preference types, we assume that $\tau=\frac \gamma{\gamma+\beta}$ is uniformly distributed on a plausible interval $[p-\Delta,p+\Delta]$, where $p=\mathbb P(T=t_1)$ and $0<\Delta<\min(p,1-p)$.

1) **Time savings under $U_1$ resulting from increasing the availability $p$ on the interval $[p-\Delta,p+\Delta]$ from $p_0$ to $p_1$**. Recall that in this example the optimal choices for preferences described by $U_1$ are the quantiles:
\[q_\tau = \begin{cases}t_1,&\tau\in[0,p]\\t_2,&\tau\in(p,1].\end{cases}\]
The total time savings, $tts_1$, resulting from changing $p$ from $p_0$ to $p_1$ are:
\[tts_1=(p_1-p_0)\cdot (t_2-t_1).\]

2) **Time savings under $U_2$ resulting from increasing the availability $p$ on the interval $[p-\Delta,p+\Delta]$ from $p_0$ to $p_1$**.
Recall that in this example the optimal choices for preferences described by $U_1$ are the quantiles:
\[e_\tau = \frac{(1-\tau)t_1p+ \tau t_2(1-p)}{(1-\tau)p + \tau(1-p)} = t_1\phi(1-\tau,p)+ t_2\phi(\tau,1-p),\]
where $\phi(x,y)=\frac{x y}{xy+(1-x)(1-y)}.$
The total time savings, $tts_2$, resulting from changing $p$ from $p_0$ to $p_1$ can be computed as:
\[tts_2 = \frac 1{2\Delta}t_1\int_{p-\Delta}^{p+\Delta}\left(\phi(1-\tau,p_0)-\phi(1-\tau,p_1)\right)d\tau + t_2\int_{p-\Delta}^{p+\Delta}\left(\phi(\tau,1-p_0)-\phi(\tau,1-p_1)\right)d\tau.\]

Likewise, the time savings effects can be calculated for the case of increasing accessibility in terms reducing the alternative travel time $t_2$. The resulting time savings are illustrated as shaded areas in Figure \@ref(fig:figex12).

```{r figex12, out.width="100%", fig.height = 3, fig.width = 10,fig.cap = "Left panel: the expectile and the quantile functions for the two-value discrete distribution with varying $p$. Right panel: the expectile and the quantile functions for the two-value discrete distribution with varying $t_2$"}
t<-10
l<-100
p0<-0.7
p1<-0.8
par(xpd=T,mfrow=c(1,2),mar=c(3,2,2,2))
taus<-c(seq(0.01,0.99,0.01),0.999)
mutau<-((1-taus)*t*p0 + taus*(t+l)*(1-p0))/((1-taus)*p0 + taus*(1-p0))
qtau<-rep(t, length(taus)); qtau[taus>p0]<-t+l

par(xpd=T)
mutau1<-((1-taus)*t*p1 + taus*(t+l)*(1-p1))/((1-taus)*p1 + taus*(1-p1))
qtau1<-rep(t,length(taus)); qtau1[taus>p1]<-t+l

#
plot(taus[taus<p0],qtau[taus<p0],type="l",ylim=c(0,120), xlim=c(0,1.2),axes=F,xlab="", ylab="",col=2, lwd=2)
lines(taus,mutau,lty=1,col=4, lwd=2)
lines(taus,mutau1,lty=2,col=4, lwd=2)
#lines(taus[taus<p0],qtau[taus<p0],lty=1,col=scales::alpha(2,0.5),lwd=1.5)
lines(taus[taus>p0],qtau[taus>p0],lty=1,col=scales::alpha(2,0.7),lwd=2)
lines(taus[taus<p1],qtau1[taus<p1],lty=2,col=2,lwd=2)
lines(taus[taus>p1],qtau1[taus>p1],lty=2,col=2,lwd=2)
arrows(-0.01,-5,-0.01,120,code=2,length=0.1)
arrows(-0.1,0.1,1.1,0,code=2,length=0.1)
#legend(0.1,100,lty=c(1,2),legend=c(paste0("p = ",p0),paste0("p = ",p1)),bty="n")
legend(0.1,100,lty=c(1,2),lwd=c(2,2),legend=c(bquote(p == p[0]),bquote(p == p[1])),bty="n")

legend(0.1,70,col=c(4,2),lwd=c(2,2),legend=c(bquote(e[tau](tau)),bquote(q[tau](tau))),bty="n")
text(0.5,-10,bquote(tau),pos=1)
#text(-0.01,60,bquote(q[tau]),pos=2)
text(-0.01,t,bquote(t[1]), pos=2)
text(-0.01,t+l,bquote(t[2]), pos=2)
text(0,0,0,pos=1)
#text(1,0,1,pos=1)
points(c(0),c(-0.1),pch="|",cex=0.5)
points(c(-0.01,-0.01),c(t,t+l),pch="-",cex=1)

arrows(p0,0,p1,0,code=0,lwd=3)
points(c(0,p0),c(-0.1,0),pch="|",cex=0.5)
points(c(0,p1),c(-0.1,0),pch="|",cex=0.5)
text(p0,0,bquote(p[0]),pos=1, cex=0.8)
text(p1,0,bquote(p[1]),pos=1,cex=0.8)

#p-Delta,p+Delta
Delt<-0.15
points(c(0,(p0+p1)/2+Delt),c(-0.1,0),pch="|",cex=0.7)
points(c(0,(p0+p1)/2-Delt),c(-0.1,0),pch="|",cex=0.7)
text((p0+p1)/2+Delt,-0.2,bquote(p+Delta),pos=1, cex=0.8)
text((p0+p1)/2-Delt,0,bquote(p-Delta),pos=1,cex=0.8)

# shaded area
# q
polygon(c(p0,p1,p1,p0,p0,p0), c(t,t,t+l,t+l,t,t), col=scales::alpha(2,0.2),border=NA)
# e
tseq<-seq((p0+p1)/2-Delt,(p0+p1)/2+Delt, 0.01)
museq_p0<-((1-tseq)*t*p0 + tseq*(t+l)*(1-p0))/((1-tseq)*p0 + tseq*(1-p0))
museq_p1<-((1-tseq)*t*p1 + tseq*(t+l)*(1-p1))/((1-tseq)*p1 + tseq*(1-p1))
polygon(c(tseq,(p0+p1)/2+Delt, rev(tseq),(p0+p1)/2-Delt), c(museq_p0,museq_p1[length(museq_p1)], rev(museq_p1),museq_p0[1]), col=scales::alpha(4,0.2),border=NA)

###################################################################################################
par(xpd=T)
l2<-50
mutau2<-((1-taus)*t*p0 + taus*(t+l2)*(1-p0))/((1-taus)*p0 + taus*(1-p0))
qtau2<-rep(t,length(taus)); qtau2[taus>p0]<-t+l2

plot(taus,mutau,type="l",ylim=c(0,120), xlim=c(0,1.2),axes=F,xlab="", ylab="",col=4, lwd=2)
lines(taus,mutau2,lty=2,col=4, lwd=2)
lines(taus[taus<p0],qtau[taus<p0],lty=1,col=scales::alpha(2,0.7),lwd=2)
lines(taus[taus>p0],qtau[taus>p0],lty=1,col=scales::alpha(2,0.7),lwd=2)
lines(taus[taus<p0],qtau2[taus<p0],lty=2,col=2,lwd=2)
lines(taus[taus>p0],qtau2[taus>p0],lty=2,col=2,lwd=2)
arrows(-0.01,-5,-0.01,120,code=2,length=0.1)
arrows(-0.1,0.1,1.1,0,code=2,length=0.1)
#legend(0.1,100,lty=c(1,2),legend=c(paste0("p = ",p0),paste0("p = ",p1)),bty="n")
legend(0.1,100,lty=c(2),lwd=2,legend=c(bquote(t[2] %down% tilde(t)[2])),bty="n")

legend(0.1,70,col=c(4,2),lwd=c(2,2),legend=c(bquote(e[tau](tau)),bquote(q[tau](tau))),bty="n")
text(0.5,-10,bquote(tau),pos=1)
#text(-0.01,60,bquote(q[tau]),pos=2)
text(-0.01,t,bquote(t[1]), pos=2)
text(-0.01,t+l,bquote(t[2]), pos=2)
text(0,0,0,pos=1)
#text(1,0,1,pos=1)
points(c(0),c(-0.1),pch="|",cex=0.5)
points(c(-0.01,-0.01),c(t,t+l),pch="-",cex=1)

arrows(p0,0,(p0+p1)/2+Delt,0,code=0,lwd=3)
points(c(0,p0),c(-0.1,0),pch="|",cex=0.5)
#points(c(0,p1),c(-0.1,0),pch="|",cex=0.5)
text(p0,0,bquote(p[0]),pos=1, cex=0.8)
#text(p1,0,bquote(p[1]),pos=1,cex=0.8)

#p-Delta,p+Delta
Delt<-0.15
points(c(0,(p0+p1)/2+Delt),c(-0.1,0),pch="|",cex=0.7)
points(c(0,(p0+p1)/2-Delt),c(-0.1,0),pch="|",cex=0.7)
text((p0+p1)/2+Delt,-0.2,bquote(p+Delta),pos=1, cex=0.8)
text((p0+p1)/2-Delt,0,bquote(p-Delta),pos=1,cex=0.8)

# shaded area
# q
polygon(c(p0,(p0+p1)/2+Delt,(p0+p1)/2+Delt,p0,p0,p0), c(t+l,t+l,t+l2,t+l2,t+l,t+l), col=scales::alpha(2,0.2),border=NA)
# e
tseq<-seq((p0+p1)/2-Delt,(p0+p1)/2+Delt, 0.01)
museq_l<-((1-tseq)*t*p0 + tseq*(t+l)*(1-p0))/((1-tseq)*p0 + tseq*(1-p0))
museq_l2<-((1-tseq)*t*p0 + tseq*(t+l2)*(1-p0))/((1-tseq)*p0 + tseq*(1-p0))
polygon(c(tseq,(p0+p1)/2+Delt, rev(tseq),(p0+p1)/2-Delt), c(museq_l,museq_l2[length(museq_l2)], rev(museq_l2),museq_l[1]), col=scales::alpha(4,0.2),border=NA)
```

Although the absolute effect sizes (at least for our concrete choice of example values) in the quantile specification seem to dominate those in the expectile case, all commuters ($\tau\in[p-\Delta,p+\Delta]$) adjust their behavior in the expectile case. In contrast, for the quantile case, the change in $p$ only influences commuters with preferences $\tau\in[p_0,p_1]$ when $p$ changes and $\tau\in[p_0,p+\Delta]$ when $t_2$ changes.

***

In Examples \@ref(exm:duqande) and \@ref(exm:qdzheng), we considered mixtures of distributions to model travel times under two regimes: free flow and congestion. Let us now take a closer look at how commuters react to a higher probability of extreme travel times under both utility specifications.


```{r figexp22, out.width="100%",fig.height = 3, fig.width = 10, fig.cap="Left panel: The inverse quantile and expectile functions for varying value of $a_4$ in Example 3.2. Right panel: The inverse quantile and expectile functions for varying value of the dispertion parameter $\\theta_c$ in Example 3.3."}


a1<-10
b1<-20

a2<-30
b2<-110
b22<-140

p0<-0.700
mutaus<-seq(a1,b2,0.5)
mutaus2<-seq(a1,b22,0.5)

p1<-0.8

taufs<-sapply(mutaus,tauf,a1=a1,b1=b1,a2=a2,b2=b2,p=p0)
mutauss<-approx(taufs, mutaus, xout=taus)

taufs1<-sapply(mutaus,tauf,a1=a1,b1=b1,a2=a2,b2=b2,p=p1)
mutauss1<-approx(taufs1, mutaus, xout=taus)

qtauss<-sapply(taus,qtausf,a1=a1,b1=b1,a2=a2,b2=b2,p=p0)
qtauss1<-sapply(taus,qtausf,a1=a1,b1=b1,a2=a2,b2=b2,p=p1)

qtauss2<-sapply(taus,qtausf,a1=a1,b1=b1,a2=a2,b2=b22,p=p0)

taufs2<-sapply(mutaus2,tauf,a1=a1,b1=b1,a2=a2,b2=b22,p=p0)
mutauss2<-approx(taufs2, mutaus2, xout=taus)

#################
par(xpd=T, mfrow=c(1,2), mar=c(3.8,2,1,2))

####################################################################################################
plot(c(a1,b1),c(p0,p0),type="l",axes=F,ylim=c(0,1.2),xlim=c(0,b22+10),ylab="",xlab="",lwd=2,col=NA)
arrows(-10,0,b22+10,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)
text(-0.1,0.5,bquote(tau),pos=2)
text(-0.1,0.04,0,pos=2)
text(-0.1,1,1,pos=2)
points(rep(-0.1,1),c(1),pch="-")
points(c(a1,b1,a2,b2,b22),rep(0,5),pch="|", cex=0.5)
text(a1,0,bquote(a[1]),pos=1)
text(a2,0,bquote(a[3]),pos=1)
text(b1,0,bquote(a[2]),pos=1)
text(b2,0,bquote(a[4]),pos=1)
text(b22,0,bquote(tilde(a)[4]),pos=1)
#
lines(mutauss$y,mutauss$x,pch="|",col=4,cex=0.5, lwd=2)
#lines(mutauss1$y,mutauss1$x,pch="|",col=4,cex=0.5,lty=2)
lines(c(mutauss2$y,b22),c(mutauss2$x,1),pch="|",col=4,cex=0.5,lty=2, lwd=2)
#
lines(qtauss[taus<p0],taus[taus<p0],pch="|",cex=0.5,col=2, lwd=2)
lines(c(a2,qtauss[taus>p0]),c(p0,taus[taus>p0]),pch="|",cex=0.5,col=2, lwd=2)
#
#lines(qtauss1[taus<p1],taus[taus<p1],pch="|",cex=0.5,col=2,lty=2)
#lines(c(a2,qtauss1[taus>p1]),c(p1,taus[taus>p1]),pch="|",cex=0.5,col=2,lty=2)
#
lines(qtauss2[taus<p0],taus[taus<p0],pch="|",cex=0.5,col=2,lty=2, lwd=2)
lines(c(a2,qtauss2[taus>p0]),c(p0,taus[taus>p0]),pch="|",cex=0.5,col=2,lty=2, lwd=2)
#
#p-Delta,p+Delta
Delt<-0.15
points(c(-0.1,0,0),c(0,p0,(p0+p1)/2+Delt),pch="-",cex=1.1)
points(c(-0.1,0),c(0,(p0+p1)/2-Delt),pch="-",cex=1.1)
text(-1,(p0+p1)/2+Delt,bquote(p+Delta),pos=2, cex=0.8)
text(-1,(p0+p1)/2-Delt,bquote(p-Delta),pos=2,cex=0.8)
text(-1,p0,bquote(p[0]),pos=2,cex=0.8)
# shaded area
ind<-taus>=(p0+p1)/2-Delt&taus<=(p0+p1)/2+Delt
tseq<-taus[ind]#seq((p0+p1)/2-Delt,(p0+p1)/2+Delt, 0.01)
qseq<-qtauss[ind]
qseq2<-qtauss2[ind]
museq<-mutauss$y[ind]
museq2<-mutauss2$y[ind]
# e
polygon(c(museq,museq2[length(museq2)], rev(museq2),museq[1]), c(tseq,(p0+p1)/2+Delt, rev(tseq),(p0+p1)/2-Delt), col=scales::alpha(4,0.2),border=NA)
# q
polygon(c(qseq,qseq2[length(qseq2)], rev(qseq2),qseq[1]), c(tseq,(p0+p1)/2+Delt, rev(tseq),(p0+p1)/2-Delt), col=scales::alpha(2,0.2),border=NA)
#
legend(90,0.5,col=c(2,4),lwd=c(2,2),legend=c(bquote(tau(q[tau])),bquote(tau(e[tau]))),bty="n")
#legend(50,0.5,lty=c(1,2),lwd=c(1,1),legend=c(paste0("p = ",p0),paste0("p = ",p1)),bty="n")
legend(50,0.5,lty=c(2),lwd=c(2),legend=c(bquote(a[4]%up% tilde(a)[4])),bty="n")

#grid
arrows(0,(p0+p1)/2-Delt,mutauss2$y[taus==(p0+p1)/2-Delt],code=0,lty=2,col="gray44")
arrows(0,(p0+p1)/2+Delt,qtauss2[taus==(p0+p1)/2+Delt],code=0,lty=2,col="gray44")
tol = 1e-5
arrows(0,(p0),qtauss[abs(taus-p0)<=tol],code=0,lty=2,col="gray44")
arrows(0,p0,0,(p0+p1)/2+Delt,code=0,lwd=3)

###########################################################################################################

xx<-seq(0,120,0.1)
mycol1<-mycol2<-1

taus<-seq(0,1,0.01)
qtaus<-quantile(times,taus)
mutaus<-expectreg::expectile(times, taus)

qtaus1<-quantile(times1,taus)
mutaus1<-expectreg::expectile(times1, taus)

qtaus2<-quantile(times2,taus)
mutaus2<-expectreg::expectile(times2, taus)

################

plot(mutaus,taus,type="l",axes=F,ylim=c(0,1.1),xlim=c(0,110),ylab="",xlab="",lwd=2,col=4)
lines(qtaus, taus, col=2, lwd=2)

arrows(-10,0,120,0,code=2,length=0.1)
arrows(0,-0.1,0,1.1,code=2,length=0.1)
points(c(0),c(1),pch="-")

#text(-0.1,c(p), bquote(p[0]),pos=2)
#text(-0.1,c(p1), bquote(p[1]),pos=2)
text(-0.1,c(1,0.04),c("1","0"),pos=2)
text(0,0.5,bquote(tau),pos=2)

#lines(mutaus1,taus,col=4,lty=2)
#lines(qtaus1,taus,col=2,lty=2)

lines(mutaus2,taus,col=4,lty=2, lwd=2)
lines(qtaus2,taus,col=2,lty=2, lwd=2)

#
#p-Delta,p+Delta
Delt<-0.15
points(c(-0.1,0,0),c(0,p0,(p0+p1)/2+Delt),pch="-",cex=1.1)
points(c(-0.1,0),c(0,(p0+p1)/2-Delt),pch="-",cex=1.1)
text(-1,(p0+p1)/2+Delt,bquote(p+Delta),pos=2, cex=0.8)
text(-1,(p0+p1)/2-Delt,bquote(p-Delta),pos=2,cex=0.8)
text(-1,p0,bquote(p[0]),pos=2,cex=0.8)
# shaded area
ind<-taus>=(p0+p1)/2-Delt&taus<=(p0+p1)/2+Delt
tseq<-taus[ind]#seq((p0+p1)/2-Delt,(p0+p1)/2+Delt, 0.01)
qseq<-qtaus[ind]
qseq2<-qtaus2[ind]
museq<-mutaus[ind]
museq2<-mutaus2[ind]
# e
polygon(c(museq,museq2[length(museq2)], rev(museq2),museq[1]), c(tseq,(p0+p1)/2+Delt, rev(tseq),(p0+p1)/2-Delt), col=scales::alpha(4,0.2),border=NA)
# q
polygon(c(qseq,qseq2[length(qseq2)], rev(qseq2),qseq[1]), c(tseq,(p0+p1)/2+Delt, rev(tseq),(p0+p1)/2-Delt), col=scales::alpha(2,0.2),border=NA)
#

legend(60,0.5,col=c(2,4),lwd=c(2,2),legend=c(bquote(tau(q[tau])),bquote(tau(e[tau]))),bty="n")
legend(20,0.5,lty=c(2),lwd=c(2),legend=c(bquote(theta[c]%up%tilde(theta)[c])),bty="n")
text(55,0,"t",pos=1)

#grid
arrows(0,(p0+p1)/2-Delt,mutaus2[taus==(p0+p1)/2-Delt],code=0,lty=2,col="gray44")
arrows(0,(p0+p1)/2+Delt,qtaus2[taus==(p0+p1)/2+Delt],code=0,lty=2,col="gray44")
tol = 1e-5
arrows(0,(p0),qtaus[abs(taus-p0)<=tol],code=0,lty=2,col="gray44")
arrows(0,p0,0,(p0+p1)/2+Delt,code=0,lwd=3)
#arrows(0,p0,0,(p0+p1)/2+Delt,code=0,lwd=3,col=2)
#arrows(-1,(p0+p1)/2-Delt,-1,(p0+p1)/2+Delt,code=0,lwd=3,col=4)
```

On Figure \@ref(fig:figexp22), we observe departure time adjustments across the entire range of the preference parameter $\tau\in[p-\Delta,p+\Delta]$ in the case of $U_2$. In contrast, with $U_1$, the behavioral reaction is limited to $\tau\in[p_0,p+\Delta]$. From a behavioral perspective, it is not clear why only specific preference ranges are effected by the changes in travel time distribution.

Overall, $U_2$ seem to capture preference adjustments to policy in a transparent and interpretable way, making it a valid alternative to the classical scheduling utility represented by $U_1$.

## Travel time reliability ratio under asymmetric scheduling preferences

As noted in @li_etal17 and @zang2022 among others, travel time reliability is a commonly recognized measure for assessing transportation network risks. Here we employ the Travel Time Reliability Ratio (TTRR), denoted here as $\rho_a$, for quantifying travel time reliability in utility terms. This ratio relates the value of travel time variability and to the value of travel time, defined as (e.g., @carrion_levinson12):

\begin{align}
\rho_a = \frac{d\mathbb EU_a^*}{d\sigma^a_T}/\frac{d\mathbb EU_a^*}{d\mu_T}, (\#eq:rho)
\end{align}

where $\mu_T$ and $\sigma_T$ refer to the mean and the standard deviation of $T$. Because the asymmetric quadratic 
utility with $a=2$ includes penalties for *squared* early and late delays, it is reasonable to define the value of travel time variability in relation to $\sigma_T^2$ to preserve unit consistency.

Assuming $U_1$ is the traveler's utility function, @fosgerau2010 show that the TTRR is:

\begin{align}
\rho_1 = \frac{d\mathbb EU_1^*}{d\sigma_T}/\frac{d\mathbb EU_1^*}{d\mu_T} = \frac{\beta+\gamma}{\alpha}\int_{\frac{\gamma}{\beta+\gamma}}^1 F^{-1}(p)dp.
(\#eq:rho11)
\end{align}

Computation of the right-hand-side of \@ref(eq:rho11) is not straightforward, and @li2019 proposes a procedure based on the conditional value at risk to compute it. Below, we derive expressions for $\rho_a, a\in\{1,2\}$ based on our notion of $\mathbb EU_a(d,T)$, utilizing the expectation of an asymmetric norm. We propose computation based on empirical partial moments.

::: {#proprho .proposition name="Travel time reliability ratio"}
Let $U_a(d,T), a\in\{1,2\}$ be the traveler's utility function as in \@ref(eq:ua) with $\beta>0$ and $\gamma>0$ known. Let  $T$ be a random travel time with distribution function $F$ and a finite mean $\mu_T$ and variance $\sigma_T^2$. Then, the travel time reliability ratio $\rho_a$ is determined as:

\[\rho_a = \frac{\gamma+\beta}{\alpha}\mathbb E||T_S-h_{a,\tau_a}(T_S)||_{a,\tau}^a,\]

where $h_{a,\tau}(\cdot) = \begin{cases} q_\tau(\cdot),&\text{for } a=1,\\ e_\tau(\cdot),&\text{for }a=2,\end{cases}$ and $\tau = \frac{\gamma}{\beta+\gamma}$.
:::

```{proof}

Using $h_{a,\tau}(T) = \sigma_T^a h_{a,\tau}(T_s)$ with $T_S$ being the standardized version of $T$ (Proposition \@ref(prp:propprops))  and 

\begin{align*}\mathbb E||T-h_{a,\tau}(T)||_{a,\tau}^a&=\mathbb E||(\sigma_TT_S + \mu_T)-(\sigma_Th_{a,\tau}(T_S)+\mu_T)||_{a,\tau}^a \\
&= \mathbb E||\sigma_T(T_S-h_{a,\tau}(T_S))||_{a,\tau}^a = \sigma_T^a\mathbb E||T_S-h_{a,\tau^*}(T_S)||_{a,\tau}^a,\end{align*}

we rewrite:
  
$$\mathbb E U_a^*(d,T) =-\alpha \mu_T - (\gamma+\beta)\mathbb E||T-h_{a,\tau}(T)||_{a,\tau}^a\\
=-\alpha \mu_T - (\gamma+\beta)\sigma_T^a\mathbb E||T_S-h_{a,\tau}(T_S)||_{a,\tau}^a.$$

The value of the travel time is:
$$\frac{d\mathbb EU_a^*}{d\mu_T} = -\alpha.$$
The value of the travel time variability is:
$$\frac{d\mathbb EU_a^*}{d\sigma^a_T} = -(\gamma+\beta)\mathbb E||T_S-h_{a,\tau}(T_S)||_{a,\tau}^a.$$
Plugging the above expressions in \@ref(eq:rho), we get:
$$\rho_a=\frac{\gamma+\beta}{\alpha}\mathbb E||T_S-h_{a,\tau}(T_S)||_{a,\tau}^a.$$
```

Proposition \@ref(prp:proprho) shows, that for $a=1$ we get:
\begin{equation}\rho_1 = \frac{(\gamma+\beta)}{\alpha}\mathbb E||T_S-q_{\tau_1}(T_S)||_{1,\tau_1}. (\#eq:rho1)
\end{equation}

In case $a=2$, the TTRR becomes:
\begin{equation}\rho_2=\frac{\gamma+\beta}{\alpha}\mathbb E||T_S-e_{\tau_2}(T_S)||_{2,\tau_2}^2. (\#eq:rho2)
\end{equation}

The terms $\mathbb E||T_S-q_{\tau_1}(T_S)||_{1,\tau_1}$ and $\mathbb E||T_S-e_{\tau_2}(T_S)||_{2,\tau_2}^2$ represent respectively the $\tau$-deviation $Dev_\tau(T_S)$ defined in \@ref(eq:tdev) and the $\tau$-variance $Var_\tau(T_S)$ defined in \@ref(eq:tvar). As discussed in the examples above, while \@ref(eq:rho1) can be problematic in situations where the respective quantiles are not well defined, an expectile-based measure in \@ref(eq:rho2) is feasible for all distributions with finite mean and variance. 

The estimates for both expressions can be obtained using their empirical counterparts:

\begin{equation}\widehat{Dev_\tau} (T_S) = \frac 1n\sum_{i=1}^n |\tau^*- \mathbf 1_{t_{S,i}\leq q_{\tau^*}}|\cdot|t_{S,i}-\hat q_{\tau^*}|(\#eq:etdev)
\end{equation}
and 

\begin{equation}\widehat{Var_\tau} (T_S) = \frac 1n\sum_{i=1}^n |\tau^*- \mathbf 1_{t_{S,i}\leq q_{\tau^*}}|\cdot |t_{S,i}-\hat q_{\tau^*}|^2(\#eq:etvar)
\end{equation}
which are both readily calculated from a sample of travel times. @taylor2017 points out the importance of precise measurement of the right tail variation in order for such measure of variability to be useful for travelers in updating their behavior.

::: {.example #trrs name="TTRS for the distribution in Example 3.3"}

In Examples \@ref(exm:qdzheng), we considered a mixture of two gamma distributions for travel time. Let us consider the TTRRs as functions of $\tau=\frac{\gamma}{\gamma+\beta}$.

For larity, let us fix the utility parameters $\alpha$ and $\beta$, and rewrite the TTRR expressions using $\gamma = \frac \tau{1-\tau}\cdot \beta$ as follows:

\begin{align}
\rho_a(\tau) &= \frac \beta\alpha\cdot\frac1{1-\tau}\cdot\mathbb E||T_S-q_{\tau_1}(T_S)||^a_{a,\tau_a}.
\end{align}

The evolution of the TTRR with $\tau$ depends on the second part of the expression above, namely:

\[\xi_a(\tau)\equiv \frac1{1-\tau}\cdot\mathbb E||T_S-h_{a,\tau_a}(T_S)||_{a,\tau}^a,\]

which represents the $\tau$-deviation, $Dev_\tau (T_s)$, for $a=1$ and the $\tau$-variance, $Var_\tau (T_S)$, for $a=2$, respectively, weighted  by $\frac1{1-\tau}$. Neither $Dev_\tau(T_S)$ nor $Var_\tau(T_S)$ are monotonic in $\tau$ in our mixture-of-gamma-distributions example, as shown on the left panel of Figure \@ref(fig:figrho). However, the weighted version, $\xi_2(\tau)=\frac1{1-\tau}Var_\tau(T_S)$ is monotonic increasing in $\tau$, whereas $\xi_1(\tau)=\frac1{1-\tau}Dev_\tau (T_s)$ appears to have a small "bump" around the mixing parameter $p$, caused by a low density region between the two modes of the mixed distribution. The resulting $\rho_1(\tau)$ and $\rho_2(\tau)$ for $\tau\in[0.5,1)$ are shown the right panel of Figure \@ref(fig:figrho). The "bump behavior" of $\rho_1(\tau)$ around $p$ is undesirable from a utility perspective, since a small change in $\tau$ (resulting from a small change in $\gamma$) could lead to a substantial *decrease* in $\rho_1(\tau)$ in the vicinity of $p$. However, if the dense regions of mixing components overlap, the "bump" is smoothed out and the function becomes more even. In contrast, the TTRR resulting from our proposed asymmetric quadratic utility specification is a monotonic function of $\tau$ and describes the reliability requirements of commuters in a more meaningful way.

```{r}
ratios<-seq(1,200,0.1)
taus<-1 / (1+1/ratios)
taus<-seq(0.5,0.95,0.01)
p0=0.7; p1=0.8
#taus[taus==p0]<-taus[taus==p0]+0.001
ratios<-taus/(1-taus)
```


```{r}
taus<-seq(0.5,0.99,0.001)
p=1
times12<-rgamma(N,kf,scale=tf)

eexp<-rho1<-rho2<-devt<-vart<-numeric(length(taus)) # Theorem 1 in Li2019
ys<-times
yss<-(ys-mean(ys))/sd(ys)
qyss1<-quantile(yss,taus, type=1)
qyss2<-expectreg::expectile(yss,taus)
    
beta=1
alpha=2*beta

for (i in 1:length(taus)){
  gamma = taus[i]*beta/(1-taus[i])
  devt[i]<-(taus[i]*mean(((yss-qyss1[i])[yss>qyss1[i]])^(1)) + (1-taus[i])*mean(((qyss1[i] -yss)[yss<=qyss1[i]]^(1))))
  vart[i]<-(taus[i]*mean(((yss-qyss2[i])[yss>qyss2[i]])^(2)) + (1-taus[i])*mean(((qyss2[i] -yss)[yss<=qyss2[i]]^(2))))
  #
  rho1[i]<-beta/alpha*(1/(1-taus[i]))*(taus[i]*mean(((yss-qyss1[i])[yss>qyss1[i]])^(1)) + (1-taus[i])*mean(((qyss1[i] -yss)[yss<=qyss1[i]]^(1))))
  rho2[i]<-beta/alpha*(1/(1-taus[i]))*(taus[i]*mean(((yss-qyss2[i])[yss>qyss2[i]])^(2)) + (1-taus[i])*mean(((qyss2[i] -yss)[yss<=qyss2[i]]^(2))))
}
#mean(rho1)
#mean(rho2)
# scale to [0,1]
scale01<-function(x,na.rm=T){(x-min(x,na.rm=T))/(max(x,na.rm=T)-min(x,na.rm=T))}
devt<-scale01(devt)
vart<-scale01(vart)
rho1<-scale01(rho1)
rho2<-scale01(rho2)


# par(mfrow=c(1,2))
# plot(taus,devt,type="l",col=2)
# lines(taus,vart,col=4)
# plot(taus,rho1, type="l",col=2)
# lines(taus,rho2,col=4)


```


```{r figrho, out.width="100%", fig.height = 3, fig.width = 10, fig.cap = "Left panel: $\\tau$-deviation and $\\tau$-variance as functions of $\\tau$ scaled to the interval $[0,1]$. Right panel: TTRRs, $\\rho_1(\\tau)$ and $\\rho_2(\\tau)$, for the travel time distribution considerred in Example 3.3 (mixture of gamma distributions with mixing parameter $p$)."}

par(mfrow=c(1,2),mar=c(4,3,2,2))


######################################################

par(xpd=F)
plot(taus,devt,type="l",col=2, ylim=c(0,1.1),xlim=c(0.5,1.1),axes=F,xlab="",ylab="", lwd=2)
lines(taus,vart,col=4, lwd=2)

#lines(taus, ttrr11,lty=2,col=2)
#lines(taus,ttrr21,lty=2, col=4)


#text(0.41,0.75,bquote(tau[2]))

#legend(0.5,0.60,col=c(2,4),lwd=c(2,2),legend=c(bquote(rho[1](tau)),bquote(rho[2](tau))),bty="n")
legend(0.5,0.45,col=c(2,4),lwd=c(2,2),legend=c(bquote(Dev[tau](T[S])),bquote(Var[tau](T[S]))),bty="n")
arrows(0.48,0,1.1,0,code=2,length=0.1)
arrows(0.49,-0.10,0.49,1.1,code=2,length=0.1)

par(xpd=T)
text(0.75,-0.20,bquote(tau))
text(0.49,0,0, pos=2)

points(c(0.49,0.49),c(0.5,1), pch="-",cex=1.1)
points(c(0.5,p0,1),c(0,0,0),pch="|",cex=0.7)

text(0.49,0.5,0.5, pos=2)
text(0.49,1,1, pos=2)
text(0.5,0,0.5, pos=1)
text(1,0,1, pos=1)

text(p0,0,bquote(p), pos=1)
#arrows(p0,0,p0,devt[taus==p0],code=0,lty=2,col="gray44")


# text(c(0.49),c(30),bquote(rho[a]),pos=2)
# text(c(0.7),c(-10),bquote(tau),pos=1)
# text(c(0.5,0.6,0.7,0.8,0.9),c(0,0,0,0,0),c(0.5,0.6,0.7,0.8,0.9),pos=1)
# points(c(0,0),c(0.5,1), pch="-")
# points(c(0.5,0.6,0.7,0.8,0.9),c(0,0,0,0,0),pch="|",cex=0.5)
# 
# legend(0.63,60,lty=c(3),lwd=c(1),legend=c(bquote(a[4]%up% tilde(a)[4])),bty="n")
# 
# legend(50,0.5,lty=c(1,2,3),lwd=c(1,1,1),legend=c(bquote(p == p[0]),bquote(p == p[1]), bquote(a[4]%up% tilde(a)[4])),bty="n")


######################################################
#ttrrs mixed gamma
par(xpd=F)
plot(taus,rho1,type="l",col=2, ylim=c(0,1.1),xlim=c(0.5,1.1),axes=F,xlab="",ylab="", lwd=2)
lines(taus,rho2,col=4, lwd=2)

#lines(taus, ttrr11,lty=2,col=2)
#lines(taus,ttrr21,lty=2, col=4)


#text(0.41,0.75,bquote(tau[2]))

legend(0.5,0.45,col=c(2,4),lwd=c(2,2),legend=c(bquote(rho[1](tau)),bquote(rho[2](tau))),bty="n")
arrows(0.48,0,1.1,0,code=2,length=0.1)
arrows(0.49,-0.10,0.49,1.1,code=2,length=0.1)

par(xpd=T)
text(0.75,-0.20,bquote(tau))
text(0.49,0,0, pos=2)

points(c(0.49,0.49),c(0.5,1), pch="-",cex=1.1)
points(c(0.5,p0,1),c(0,0,0),pch="|",cex=0.7)

text(0.49,0.5,0.5, pos=2)
text(0.49,1,1, pos=2)
text(0.5,0,0.5, pos=1)
text(p0,0,bquote(p), pos=1)
text(1,0,1, pos=1)

#arrows(p0,0,p0,rho1[taus==p0],code=0,lty=2,col="gray44")

```

:::

In summary, our framework for optimal departure time choices, represented as tail indices of the travel time distribution, establishes a connection between these optimal choices and the characteristics of the travel time distribution. This framework introduces a new type of scheduling utility function, with well-defined expected utility maximizers for various types of travel time distributions. Additionally, it simplifies the calculation of travel time reliability ratios induced by the considered utility types.


# Empirical validation and comparison of $U_1(T,d)$ and $U_2(T,d)$

In this section, we aim to empirically validate the proposed asymmetric quadratic utility specification using both an experimental dataset on route and departure time choices (Subsection 4.1) and observational travel time data from Montreal (Subsection 4.2).

## Linear and squared scheduling losses in modelling departure time choices

To empirically validate the proposed utility specification, we compare two utility functions based on their scheduling loss components (linear vs. quadratic) using a dataset from experiments on route and departure time choices (see @Gonzalez2020 and @GONZALEZRAMIREZ2021), available at [https://figshare.com/articles/dataset/Experiments_on_route_and_departure_time/12388103](https://figshare.com/articles/dataset/Experiments_on_route_and_departure_time/12388103) (accessed on 24.11.2024). The dataset includes computer-aided route choice experiments focused on diverse optimal departure time choices, involving a total of 496 participants and 5,535 recorded choices across 41 origin-destination pairs.

In these experiments, participants were asked to choose a route and a departure time for a given arrival time from a set of 5-minute departure slots. They were provided with information on route characteristics, travel time, as well as the maximum and minimum expected lateness for the available choices. This information on expected lateness—specifically, its average—serves as a useful proxy for the scheduling component of the considered utility functions. By analyzing choices based on the average of the maximum and minimum expected lateness for $U_1$ and the average of their squared values for $U_2$, we aim to assess which loss concept (linear versus quadratic) better captures realistic departure time choices.

We model the choices, labeled in the dataset as 1 (chosen) and 0 (rejected), using a binomial regression model with probit link, which is frequently used for binary choice modelling (@ben1985discrete). The explanatory variables include the travel time $T$ provided in each experiment and either the average expected lateness (Model 1) or the average expected squared lateness (Model 2), denoted as $ELATE$ and $ELATE^2$, respectively. These variables are computed as follows:

\begin{align}ELATE &= \frac{ELATE\_max + ELATE\_min}2,\\
ELATE^2 &= \frac{ELATE^2\_max + ELATE^2\_min}2.
\end{align}
If $ELATE$ is positive, we denote it as $ELATE_{pos}$; otherwise, we write $ELATE_{neg}$. 

Since the participants were also provided with route characteristics, such as its length, directedness, number of turns and the percentage of freeway section on the route, which possibly influence the route choice, we also include those route characteristics as explanatory variables in the model (as columns of matrix $R$ in the notation below).

Thus, our model specification representing the choices based on $U_1$ ($a=1$) or on $U_2$ ($a=2$) reads:

\begin{align}p(CHOICE=1|T_{i,j},ELATE^a_{pos,i,j}, ELATE^a_{neg,i,j}, R_j) = \Phi(\alpha_{1} T_{i,j} &+ \beta_{1} ELATE^a_{pos,i,j} + \gamma_1ELATE^a_{neg,i,j}\nonumber\\
&+ \delta_1R_{j,1},+ \ldots +\delta_4R_{j,4}) (\#eq:probit) \end{align}

where $\Phi(z)$ denotes the distribution function of the standard normal distribution and $p(CHOICE=1|T_{i,j},ELATE^a_{pos,i,j}, ELATE^a_{neg,i,j}, R_j)$ denotes the individual conditional probability of selecting time slot $i$ on route $j$ from the available time slots $i=1, \ldots,n$, and routes $j=1,\ldots,J$ based on the linear loss ($a=1$) or the squared loss ($a=2$) in the scheduling component.

<!--Our second model represents choices based on $U_2$:

\begin{equation}\ln \frac{p(T_i,ELATE^2_{i,pos}, ELATE^2_{i,neg}, R_i)}{1-p(T_i,ELATE^2_{i,pos}, ELATE^2_{i,neg},R_i)} = \alpha_{2} T_i + \beta_{2} ELATE^2_{i, pos} + \gamma_2ELATE^2_{i,neg} + \delta_1R_{i,1},+ \ldots +\delta_4R_{i,4}  (\#eq:logit2) \end{equation}

where $p(T_i,ELATE^2_{i,pos}, ELATE^2_{i,neg})$ denotes the conditional probability of selecting time slot $i$ from the available time slots $i=1, \ldots,n,$ based on the squared loss in the scheduling part. -->
To assess the goodness-of-fit of the models above, we employ a leave-one-out cross-validation procedure. First, we fit the models in \@ref(eq:probit) separately for each participant, using all but one route (containing a chosen departure time) for training. We then predict the participant’s choice for the hold-out route based on the fitted models. The accuracy of these predictions is evaluated using the root mean squared prediction error (RMSPE) and the proportion of correctly predicted choices. A prediction is considered correct if the actual choice made by the participant corresponds to the time slot with the highest predicted probability. This cross-validation procedure is repeated until every route containing a chosen departure time has been left out once and the participant’s choice has been predicted accordingly. The entire procedure—including fitting the probit choice models in \@ref(eq:probit) and performing cross-validation—is repeated for each participant. 

```{r}
choices = read.csv ("./time_choices/ROUTE_DEPARTURETIME_CHOICES.csv")

i=1
num = c("TT_INFO", "ELATE_min", "ELATE_max", "LENGTH_KM", "DIRECTNESS","N_TURNS_KM","FREEWAY_PERC")
for (i in 1:length(num)){
  choices[,num[i]]<-as.numeric(gsub("\\,","\\.",choices[,num[i]]))
}
#choices


choices$DEP_TIME = as.POSIXlt.character(choices$DEP_TIME,format="%H:%M:%S")
choices$DEP_TIME_INI = as.POSIXlt.character(choices$DEP_TIME_INI,format="%H:%M:%S")
choices$PERIOD_INI5 = as.POSIXlt.character(choices$PERIOD_INI5,format="%H:%M:%S")
choices$PERIOD_FIN5 = as.POSIXlt.character(choices$PERIOD_FIN5,format="%H:%M:%S")
choices$OBJECTIVE_ARR_TIME = as.POSIXlt.character(choices$OBJECTIVE_ARR_TIME,format="%H:%M:%S")
choices$EAT_max = as.POSIXlt.character(choices$EAT_max,format="%H:%M:%S")
choices$EAT_min = as.POSIXlt.character(choices$EAT_min,format="%H:%M:%S")
choices$ELATE = (choices$ELATE_max+ choices$ELATE_min)/2
choices$ELATE_pos = 0
choices$ELATE_pos[choices$ELATE>0] = choices$ELATE[choices$ELATE>0]
choices$ELATE_neg = 0
choices$ELATE_neg[choices$ELATE<0] = -choices$ELATE[choices$ELATE<0]
choices$ELATE2 = (choices$ELATE_max^2 + choices$ELATE_min^2)/2
choices$ELATE2_pos = 0
choices$ELATE2_pos[choices$ELATE>0] = choices$ELATE2[choices$ELATE>0]
choices$ELATE2_neg = 0
choices$ELATE2_neg[choices$ELATE<0]= choices$ELATE2[choices$ELATE<0]

choices_opt = choices[choices$CHOSEN==1,]
ini_arr_time= choices_opt[1,"EAT_max"] - choices_opt[1,"ELATE_max"] 

choices = transform(choices, dt_min = OBJECTIVE_ARR_TIME - PERIOD_INI5, dt_max = OBJECTIVE_ARR_TIME - PERIOD_FIN5, dt = OBJECTIVE_ARR_TIME - DEP_TIME)
players = unique(choices$PLAYER_ID)
```

```{r}
choices = transform(choices,TT_INFO = TT_INFO/60, ELATE_pos = ELATE_pos/60, ELATE_neg = ELATE_neg/60, ELATE2_pos = ELATE2_pos/3600, ELATE2_neg = ELATE2_neg/3600)
```

```{r}
# p=1;r=2
# for(p in 1:length(players)){
#   for(r in 1:length(routes)){
#     dist_times = unique(choices$TT_INFO[choices$PLAYER_ID == players[p]&choices$PATH_NAME_UNIQUE == routes[r]])
#   }
# }
```

```{r}
# taus<-seq(0.3,0.9,0.05)
# qs = es = matrix(NA, length(routes),length(taus))
# 
# par(mfrow = c(3,5), mar=c(2,1,1,1))
# for(r in 1:length(routes)){
#   dist_times = unique(choices$TT_INFO[choices$PATH_NAME_UNIQUE == routes[r]])
#  #length(dist_times)
#   plot(density(dist_times), xlab="",ylab="",axes=F, main="")
#   axis(1)
#   qs[r,] = quantile(dist_times,probs=taus)
#   es[r,] = expectreg::expectile(dist_times, probs=taus)
# }

```

```{r}
# find_tau1 <- function(tau){
#   qtau = quantile(dist_times, tau)
#   diff = (opt_choice - qtau)^2
#   return(diff)
# }
# find_tau2 <- function(tau){
#   etau = expectreg::expectile(dist_times, tau)
#   diff = (opt_choice - etau)^2
#   return(diff)
# }
# 
# find_tau1 <- function(q,a,b){
#   tau = (q-a)/(b-a)
#   return(tau)
# }
# find_tau2 <- function(e,a,b){
#   tau = (a-e)^2/((a-e)^2+(b-e)^2)
#   return(tau)
# }
# #q_{\tau_1}(T) = b\tau_1+a(1-\tau_1)
# find_q <- function(vec){
#   tau = vec[1]; a= vec[2]; b = vec[3]
#   q = b*tau + a*(1-tau)
#   return(q)
# }
# #e_{\tau_2} = \frac{\sqrt\tau_2 b + \sqrt{1-\tau_2}a}{\sqrt\tau_2+\sqrt{1-\tau_2}}
# find_e <- function(vec){
#   tau = vec[1]; a= vec[2]; b = vec[3]
#   e = (b*sqrt(tau) + a*sqrt(1-tau)) / (sqrt(tau)+sqrt(1-tau))
#   return(e)
# }
```

```{r}
# p=1;r=2
# for(p in 1:length(players)){
#   paths_opt_choices = unique(choices$PATH_NAME_UNIQUE[choices$PLAYER_ID == players[p]&choices$CHOSEN==1])#path where we have opt choices
#   for(r in 1:length(paths_opt_choices)){
#     # choices 
#     ind = (choices$PLAYER_ID == players[p]&choices$PATH_NAME_UNIQUE == paths_opt_choices[r]&choices$CHOSEN==1)
#     opt_choice = as.numeric(choices$dt[ind])
#     dt_min = as.numeric(choices$dt_min[ind])
#     dt_max = as.numeric(choices$dt_max[ind])
#     # preferences
#     tau1 = find_tau1(opt_choice,dt_min, dt_max)
#     tau2 = find_tau2(opt_choice,dt_min, dt_max)
#     # predict for other choices
#     indho = choices$PLAYER_ID == players[p]&choices$PATH_NAME_UNIQUE != paths_opt_choices[r]&choices$CHOSEN==1
#     opt_choice_holdout = data.frame(opt_choice=as.numeric(choices$dt[indho]), tau1 = tau1, tau2=tau2, dt_min=as.numeric(choices$dt_min[indho]), dt_max=as.numeric(choices$dt_max[indho]))
#     q_preds = apply(opt_choice_holdout[,-c(1,3)],1,find_q)
#     e_preds = apply(opt_choice_holdout[,-c(1,2)],1,find_e)
#     opt_choice_holdout = cbind(opt_choice_holdout, q_preds, e_preds)
#   }
# }
```


```{r warning=FALSE}
#p=1;r=2
mse1 <- mse2 <- alpha1<-beta1<-gamma1<-alpha2<-beta2<-gamma2<-prop1<-prop2<-mods<-prop<-prop12<-prop22<-NULL
for(p in 1:length(players)){
  paths_opt_choices = unique(choices$PATH_NAME_UNIQUE[choices$PLAYER_ID == players[p]&choices$CHOSEN==1])#path where we have opt choices
  paths_nopt_choices = unique(choices$PATH_NAME_UNIQUE[choices$PLAYER_ID == players[p]&choices$CHOSEN==0])
  for(r in 1:length(paths_opt_choices)){
    # index train
    ind = (choices$PLAYER_ID == players[p]&(choices$PATH_NAME_UNIQUE%in%paths_opt_choices[-r]|choices$PATH_NAME_UNIQUE%in%paths_nopt_choices))
    if(sum(ind)>0){
    choices_train = data.frame(choice = choices$CHOSEN[ind], TT=choices$TT_INFO[ind], ELATE=choices$ELATE[ind], ELATE_pos=choices$ELATE_pos[ind], ELATE_neg = choices$ELATE_neg[ind],
                                            ELATE2=choices$ELATE2[ind],ELATE2_pos=choices$ELATE2_pos[ind], ELATE2_neg = choices$ELATE2_neg[ind], 
                               choices[ind,c("LENGTH_KM", "DIRECTNESS","N_TURNS_KM","FREEWAY_PERC")])
    # index holdout
    indho = (choices$PLAYER_ID == players[p]&choices$PATH_NAME_UNIQUE == paths_opt_choices[r])
    choices_test = data.frame(choice = choices$CHOSEN[indho], TT=choices$TT_INFO[indho], ELATE=choices$ELATE[indho], ELATE_pos=choices$ELATE_pos[indho], 
                              ELATE_neg = choices$ELATE_neg[indho],
                                             ELATE2=choices$ELATE2[indho], ELATE2_pos=choices$ELATE2_pos[indho], ELATE2_neg = choices$ELATE2_neg[indho],
                              choices[indho,c("LENGTH_KM", "DIRECTNESS","N_TURNS_KM","FREEWAY_PERC")])
    # Model 1
    mod = glm(choice~0+TT+ELATE_pos + ELATE_neg+ LENGTH_KM + DIRECTNESS + N_TURNS_KM + FREEWAY_PERC, family = binomial(link="probit"),data = choices_train)
    coefs = coef(mod)
    # Model 2
    mod2 = glm(choice~0+TT+ELATE2_pos + ELATE2_neg+ LENGTH_KM + DIRECTNESS + N_TURNS_KM + FREEWAY_PERC, family = binomial(link="probit"),data = choices_train)
    coefs2 = coef(mod2)
    # Check plausibility
    pltau1 = coefs[2]/(coefs[2]+ coefs[3])
    pltau2 = coefs2[2]/(coefs2[2]+ coefs2[3])
    if((pltau1>0&pltau1<1)&(pltau2>0&pltau2<1)){
    # save the parameters
    alpha1<-c(alpha1,coefs[1]); beta1<-c(beta1,coefs[3]); gamma1<-c(gamma1,coefs[2])
    alpha2<-c(alpha2,coefs2[1]); beta2<-c(beta2,coefs2[3]); gamma2<-c(gamma2,coefs2[2])
    # predict Model 1
    preds1 = predict(mod, newdata = choices_test, type="response")
    preds011 = rep(0, length(preds1)); preds011[which.max(preds1)]<-1
    prop1<-c(prop1,all(preds011 == choices_test$choice))
    #predict Model 2
    preds2 = predict(mod2, newdata = choices_test, type="response")
    preds012 = rep(0, length(preds2)); preds012[which.max(preds2)]<-1
    prop2<-c(prop2,all(preds012 == choices_test$choice))
    # compute the MSPE
    mse1 = c(mse1,(choices_test$choice - preds1)^2)
    mse2 = c(mse2,(choices_test$choice - preds2)^2)
    #compare the mods
    mods<-c(mods, ifelse(summary(mod)$deviance<summary(mod2)$deviance,"mod1","mod2"))
    prop<-c(prop,ifelse(mods[length(mods)]=="mod1",all(preds011 == choices_test$choice), all(preds012 == choices_test$choice)))
    }
    }
  }
}
#compute the MSPE of the mixed case
mse_mixed = c(mse1[mods=="mod1"], mse2[mods=="mod2"])

#prepare the table
tab = data.frame(Specification = c("Model 1", "Model 2", "Model 1 or Model 2"), Scheduling_Loss = c("linear","quadratic", "linear or quadratic"), RMSPE = c(round(sqrt(mean(mse1)),4),round(sqrt(mean(mse2)),4), round(sqrt(mean(mse_mixed)),4)), Proportion_Correct = round(c(sum(prop1)/length(prop1), sum(prop2)/length(prop2), sum(prop)/length(prop)),4), Proportion_Participants = c(round(table(mods)/length(mods),4),1)
                # ,r_1 = c(mean(alpha1/(beta1+gamma1)), mean(alpha2/(beta2+gamma2))), 
                         #r2 = c(mean(gamma1/(beta1+gamma1)), mean(gamma2/(beta2+gamma2)))
                )
```



```{r tableprobit}
library(dplyr)
library(kableExtra)
caption<-"Cross-validation results on the model evaluation with linear (Model 1) and quadratic (Model 2) scheduling losses. The third specification (Model 1 or Model 2) indicates the case where one of the models is selected for each participant based on the in-sample residual deviance criterion."
cln = c(paste("Specification"),paste("Scheduling Loss"),paste("RMSPE"),paste("Prop. of correct predictions"), paste("Prop. of participants"))
#tab[2, 3] <- cell_spec(tab[2, 3], bold = T)
 knitr::kable(tab, align = "lll",
               col.names = cln,
               row.names = F,
               digits = 4,
               caption = caption,
                escape=F
  )%>%kable_classic_2(full_width = F)#%>%kable_styling(font_size = 12)

```


```{r tabprobitres}
#compute the taus and their means, medians, quantiles
htau1 = gamma1/(beta1+gamma1)
htau2 = gamma2/(beta2+gamma2)
mhtau1 = mean(htau1)
mhtau2 = mean(htau2)
medhtau1 = median(htau1)
medhtau2 = median(htau2)
qlowhtau1 = quantile(htau1,0.25)
qlowhtau2 = quantile(htau2,0.25)
qhighhtau1 = quantile(htau1,0.75)
qhighhtau2 = quantile(htau2,0.75)

# prepare the table
tabres = data.frame(Specification = c("$a=1$ (Model 1)", "$a=2$ (Model 2)"), Scheduling_Loss = c("linear","quadratic"), mtau= c(mhtau1, mhtau2),
                    medhtau= c(medhtau1, medhtau2),  qlowhtau = c(qlowhtau1, qlowhtau2), qhighhtau = c(qhighhtau1, qhighhtau2))
caption<-"Cross-validation results on the scheduling coefficient ratios for the linear (Model 1) and quadratic (Model 2) scheduling losses. $\\overline{\\hat \\tau_{a,j}}$ corresponds to the mean, $\\hat q_{0.5}({\\hat \\tau_{a,j} })$ - to the median, and $\\hat q_{0.25}({\\hat \\tau_{a,j} })$ and $\\hat q_{0.75}({\\hat \\tau_{k} })$ - to the lower and to the upper quartiles respectively."

cln = c(paste("Specification"),paste("Scheduling Loss"),paste("$\\overline{\\hat \\tau_{a,j}}$"),paste("$\\hat q_{0.5}({\\hat \\tau_{a,j} })$"),paste("$\\hat q_{0.25}({\\hat \\tau_{a,j} })$"), paste("$\\hat q_{0.75}({\\hat \\tau_{k} })$"))
 knitr::kable(tabres, align = "lll",
               col.names = cln,
               row.names = FALSE,
               digits = 4,
               caption = caption,
                escape=F
  )%>%kable_classic_2(full_width = F)#%>%kable_styling(font_size = 12)

```

The results^[All computations are performed in R (@rr). The probit regression is fitted using *glm* function from the R-base. The associated code is available on [https://github.com/omanya/traffic-expectiles](https://github.com/omanya/traffic-expectiles)], aggregated across the participants, are presented in Table \@ref(tab:tableprobit). As seen in the table, while the root mean squared prediction errors of the two models are comparable, the proportion of correctly predicted choices is slightly higher when the quadratic loss specification is employed. Moreover, choosing the model specification for each participant based on the in-sample residual deviation, assigns Model 2 to a larger portion of decision makers ($71.65\%$) and achieves a large proportion of correct predictions.  This suggests that the quadratic loss better captures actual departure time choices for a large portion of individuals in the experiment.

To further assess the model’s plausibility and the preference distribution among participants, we report the average ($\overline{\hat \tau_{a,j} }$), the median ($q_{0.5}({\hat \tau_{a,j} })$), the lower quartile ($q_{0.25}({\hat \tau_{a,j} })$), and the upper quartile ($q_{0.75}({\hat \tau_{a,j} })$) for the scheduling coefficient ratios, defined as:
$$\hat \tau_{a,j} = \frac{\hat\gamma_{a,j}}{\hat\beta_{a,j}+\hat\gamma_{a,j}}$$
in Table \@ref(tab:tabprobitres). Here, $\hat\alpha_{a,j}$, $\hat\beta_{a,j}$, and $\hat\gamma_{a,j}$ denote the estimated coefficients of the $a$-th model, with $a=1$ for the asymmetric linear and $a=2$ for the asymmetric quadratic losses, and $j=1,\ldots,J$ representing the participant index. The resulting coefficient ratios appear plausible. The majority of participants seem to be highly averse to late arrivals, as the distribution of preferences $\{\hat\tau_{a,j}\}_{j=1}^J$ tends to favor high values with a relatively high probability for both model specifications.

Overall, these results suggest that the quadratic loss specification provides a more accurate representation of departure time choices compared to the linear loss model for a large portion of decision makers. The strong aversion to late arrivals observed across the participants further supports the relevance of incorporating a squared scheduling loss in utility-based departure time models.

## Optimal departure time choices under $U_1(T,d)$ and $U_2(T,d)$ for Montreal travel time data

In this section, we provide a real data example, considering a non-trivial travel time distribution, using the dataset of travel times for Montreal (the data is available at
[https://donnees.montreal.ca/dataset/temps-de-parcours-sur-des-segments-routiers-historique] (https://donnees.montreal.ca/dataset/temps-de-parcours-sur-des-segments-routiers-historique) and was accessed on 21 Aug 2024). We take  two subsets of trips from 2019 on links LND_1E-1B and LSh_01-40, collected between 6:00 and 8:00 am on regular working days (Monday through Thursday). The two links are considered as alternative routes in the analysis. As indicated by the kernel density estimates in the left panel of Figure \@ref(fig:choices), the data appear to be generated by a model with several regimes. Following @jabari2019, we model the data using a $k$-component mixture of gamma distributions. The number of components, $k=2$, for both subsets was selected based on the Akaike Information Criterion.

All computations are performed in R (@rr). The mixture of gamma distributions is fitted using the *mixtools* package (@mixtools). The empirical counterparts of quantiles and expectiles are computed utilizing the *quantile* function from the R-base and the *expectile* function  from the *expectreg* package (@expectregl, @expectreg). 


```{r}
load("tt.RData")
load("tt2.RData")
```


```{r}
load("mixmod.RData")
load("mixmod2.RData")
```


```{r}
# x1 <- seq(0, 10, 0.1)
# hist(tt, freq= FALSE, col=NA,border=NA, ylim=c(0,1),xlim=c(0,10))
# lines(density(tt), lwd = 2, col = "blue")
# lines(x1, mixmod$lambda[1]*dgamma(x1, mixmod$gamma.pars[1,1], 1/mixmod$gamma.pars[2,1]),
#       col="orange", lwd=3)
# lines(x1, mixmod$lambda[2]*dgamma(x1, mixmod$gamma.pars[1,2], 1/mixmod$gamma.pars[2,2]),
#       col="magenta", lwd=3)
# lines(x1, mixmod$lambda[3]*dgamma(x1, mixmod$gamma.pars[1,3], 1/mixmod$gamma.pars[2,3]),col="green", lwd=3)
# lines(x1, mixmod$lambda[4]*dgamma(x1, mixmod$gamma.pars[1,4], 1/mixmod$gamma.pars[2,4]),col="red", lwd=3)
# legend("topright", 
#        legend=c(paste(round(mixmod$lambda[1],3), "* Gamma ~ (",paste(round(mixmod$gamma.pars[1,1],2), round(1/mixmod$gamma.pars[2,1],2), collapse=","),")"),
#        paste(round(mixmod$lambda[2],3), "* Gamma ~ (",paste(round(mixmod$gamma.pars[1,2],2), round(1/mixmod$gamma.pars[2,2],2), collapse=","),")")
#        ,paste(round(mixmod$lambda[3],3), "* Gamma ~ (",paste(round(mixmod$gamma.pars[1,3],2), round(1/mixmod$gamma.pars[2,3],2), collapse=","),")")
#        ,paste(round(mixmod$lambda[4],3), "* Gamma ~ (",paste(round(mixmod$gamma.pars[1,4],2), round(1/mixmod$gamma.pars[2,4],2), collapse=","),")")
#         ),
#        fill=c( "orange","magenta"
#                ,"green", "red"
#                )
#   )

```

```{r}
# CDF of mixture of two gammas
CDF_gamma <- function(x, shape=mixmod$gamma.pars[1,], scale=mixmod$gamma.pars[2,], p=mixmod$lambda) {
  cdf<-0
  for(i in 1:length(p)){
    cdf<-cdf+p[i]*pgamma(x,shape[i],1/scale[i])
  }
return(cdf)
}
PDF_gamma<- function(x, shape=mixmod$gamma.pars[1,], scale=mixmod$gamma.pars[2,], p=mixmod$lambda) {
  pdf<-0
  for(i in 1:length(p)){
    pdf<-pdf+p[i]*dgamma(x,shape[i],1/scale[i])
  }
return(pdf)
}
```


```{r}
#sample from the estimated mixture
nsamples <- 10^4;
set.seed(123)
x <- runif(nsamples);

z <- z2<-c();
for (i in 1:nsamples) {
  # find the root within (0,1) 
  r <- uniroot(function(y,u){CDF_gamma(y)-u}, c(1,100), tol = 0.0001, u = x[i])$root;
  r2 <- uniroot(function(y,u){CDF_gamma(y, shape=mixmod2$gamma.pars[1,], scale=mixmod2$gamma.pars[2,], p=mixmod2$lambda)-u},
                c(1,100), tol = 0.0001, u = x[i])$root;
  z <- c(z, r);
  z2<- c(z2, r2)
}

#mean(z)
#quantile(z,0.99)
```



```{r tabpars}
tbl<-round(cbind(rbind(c(mixmod$lambda[2],mixmod$gamma.pars[1,2],mixmod$gamma.pars[2,2],
                 mixmod$lambda[1],mixmod$gamma.pars[1,1],mixmod$gamma.pars[2,1]),
                   
                 c(mixmod2$lambda[1],mixmod2$gamma.pars[1,1],mixmod2$gamma.pars[2,1],
                   mixmod2$lambda[2],mixmod2$gamma.pars[1,2],mixmod2$gamma.pars[2,2])),
            
                 c(mixmod$gamma.pars[1,2]*mixmod$gamma.pars[2,2],mixmod2$gamma.pars[1,1]*mixmod2$gamma.pars[2,1]),     
           c(mixmod$gamma.pars[1,1]*mixmod$gamma.pars[2,1], mixmod2$gamma.pars[1,2]*mixmod2$gamma.pars[2,2]),
           c(sqrt(mixmod$gamma.pars[1,2]*mixmod$gamma.pars[2,2]^2), sqrt(mixmod2$gamma.pars[1,1]*mixmod2$gamma.pars[2,1]^2)),
           c(sqrt(mixmod$gamma.pars[1,1]*mixmod$gamma.pars[2,1]^2), sqrt(mixmod2$gamma.pars[1,2]*mixmod2$gamma.pars[2,2]^2)))
           ,2)

#tbl<-rbind(tbl[1:3,order(tbl[1,], decreasing=F)],tbl[4:6,order(tbl[4,], decreasing=F)])

rownames(tbl)<-paste0("route ",1:nrow(tbl))
colnames(tbl)<-c("$p_{1,.}$","$k_{1,.}$","$\\theta_{1,.}$","$p_{2,.}$","$k_{2,.}$","$\\theta_{2,.}$", "$\\mu_{1,.}$","$\\mu_{2,.}$","$\\sigma_{1,.}$","$\\sigma_{2,.}$")

caption<-paste0("The estimated parameters of the two-component gamma mixture model (sample sizes $n_{1}=",length(tt), "$ and $n_{2}=", length(tt2),"$).")

 knitr::kable((tbl), align = "llll",
               col.names = colnames(tbl),
               row.names = TRUE,
               digits = 3,
               caption = caption,
               escape=F
  )

 # mean and var of mixture: https://math.stackexchange.com/questions/3689141/calculating-the-mean-and-standard-deviation-of-a-gaussian-mixture-model-of-two-c
```


As shown in Table \@ref(tab:tabpars), the estimated models for route 1 and route 2 travel times assign similar probabilities for the free-flow regime, captured by the first component (`r sum(tbl[1,1])` and `r sum(tbl[2,1])` respectively), and the congestion regime (`r sum(tbl[1,4])` and `r sum(tbl[2,4])` respectively). Note that, although  the second model is associated with a higher probability of the free-flow regime (`r tbl[2,1]` compared to `r tbl[1,1]`),  it also reveals higher means and standard deviations in both regimes ($\mu_{1,2}=`r tbl[2,7]`$ and $\mu_{1,2}=`r tbl[2,8]`$ compared to $\mu_{1,1}=`r tbl[1,7]`$ and $\mu_{1,2}=`r tbl[1,8]`$, as well as $\sigma_{1,2}=`r tbl[2,9]`$ and $\sigma_{1,2}=`r tbl[2,10]`$ compared to $\sigma_{1,1}=`r tbl[1,9]`$ and $\sigma_{1,2}=`r tbl[1,10]`$), resulting in higher probability of right extremes. In the following analysis, we examine the choices based on the proposed utility formulations.

```{r}
ratios<-seq(1,200,0.1)
taus<-1 / (1+1/ratios)
#taus<-c(seq(0.5,0.99,0.01),0.999)
taus<-c(seq(0.5,0.99,0.01))

beta=0.25
alpha=2*beta
ratios<-taus/(1-taus)
gammas<-ratios*beta
#which(taus==0.999)
```



```{r}
# as if the estimated model were the true model
ys<-z; ys2<-z2
exps<-sapply(taus,expectreg::expectile, x=ys)
qs<-sapply(taus,quantile, x=ys)
exps2<-sapply(taus,expectreg::expectile, x=ys2)
qs2<-sapply(taus,quantile, x=ys2)

# estimated
expse<-sapply(taus,expectreg::expectile, x=tt)
qse<-sapply(taus,quantile, x=tt)
expse2<-sapply(taus,expectreg::expectile, x=tt2)
qse2<-sapply(taus,quantile, x=tt2)
```

```{r}
tauss<-c(seq(0.5,0.95,0.01))
# utilities
u1<-u2<-u12<-u22<-devt<-vart<-devt2<-vart2<-numeric(length(tauss))
for (i in 1:length(tauss)){
  gamma = gammas[i]
  tau<-tauss[i]
  devt[i]<-(tau*mean(((ys-qs[i])[ys>qs[i]])^(1)) + (1-tau)*mean(((qs[i] -ys)[ys<=qs[i]])^(1)))
  vart[i]<-(tau*mean(((ys-exps[i])[ys>exps[i]])^(2)) + (1-tau)*mean(((exps[i] -ys)[ys<=exps[i]])^(2)))
  devt2[i]<-(tau*mean(((ys2-qs2[i])[ys2>qs2[i]])^(1)) + (1-tau)*mean(((qs2[i] -ys2)[ys2<=qs2[i]])^(1)))
  vart2[i]<-(tau*mean(((ys2-exps2[i])[ys2>exps2[i]])^(2)) + (1-tau)*mean(((exps2[i] -ys2)[ys2<=exps2[i]])^(2)))
  #
  u1[i]<- -(mean(ys)*alpha+(gamma+beta)*devt[i])
  u2[i]<- -(mean(ys)*alpha+(gamma+beta)*vart[i])
  u12[i]<- -(mean(ys2)*alpha+(gamma+beta)*devt2[i])
  u22[i]<- -(mean(ys2)*alpha+(gamma+beta)*vart2[i])
}

# # plot utilities
# plot(tauss,u1, type="l",col=2, axes=F, ylab=bquote(U[a](T,d[a])), xlab=bquote(tau), 
#      ylim=c(-200,0), xlim=c(0.5,1))
# lines(tauss,u2,col=4)
# lines(tauss,u22,col=4, lty=2)
# lines(tauss,u12,col=2, lty=2)
# 
# axis(1)
# axis(2)
##The difference between u1s is rather subtile; a stronger preference towards route 2 is revealed by u2.


```

The corresponding optimal departure time choices for both utility types are plotted in Figure \@ref(fig:choices). On the right panel of the figure, we show the estimated optimal choices as quantiles for $U_1$ and expectiles for $U_2$, varying the preference parameter $\tau=\frac{\gamma}{\beta+\gamma}$. We estimate the quantiles and the expectiles based on the fitted mixture distributions using Monte-Carlo approximation and the formulas in \@ref(eq:q) and \@ref(eq:e). 

```{r choices, out.width="100%",  fig.height = 3, fig.width = 10,fig.cap = "Left panel: Kernel density estimates for the considered travel times. Right panel: Optimal choices as the quantiles for $U_1$ and expectiles for $U_2$  under different preference specification $\\tau$ based on the fitted mixture model."}
par(lwd=2, mfrow=c(1,2),mar=c(4,3,2,2))

# Create the layout
#nf <- layout( matrix(c(1,1,2,3), nrow=2, byrow=TRUE))
den<-density(tt); den2<-density(tt2)
#plot(den$x,den$y,ylim=c(-0.01,1),axes=F, xlim=c(0,8), main="", xlab="travel time",ylab="density estimate", type="l")
plot(den$x,den$y,ylim=c(-0.01,0.20),axes=F, xlim=c(0,30), main="", xlab="travel time",ylab="density estimate", type="l")
#lines(den2$x, den2$y, col="orange")
lines(den2$x, den2$y, col="gray55", lty=2)
points(tt, rep(-0.01,length(tt)),pch="|",col=scales::alpha("gray33",0.5))
par(xpd=T)
#points(tt2, rep(-0.1,length(tt2)),pch="|",col=scales::alpha("orange",0.5))
points(tt2, rep(-0.03,length(tt2)),pch="|",col=scales::alpha("gray66",0.5))
par(xpd=F)
#points(den$x,PDF_gamma(den$x),col=2, pch=16, cex=0.5)
axis(1,cex.axis=0.8)
axis(2, at=c(0,0.1,0.2),las=1,cex.axis=0.8)
legend(20,0.2,col=c(1, "gray55"),lwd=c(2,2),lty=c(1,2),legend=c("route 1","route 2"),bty="n")
############################################
#plot(taus,qs,ylim=c(1,8),xlim=c(0.7,1),type="l",axes=F,col=NA,xlab=bquote(tau), ylab=bquote(e[tau]~q[tau]))
plot(taus,qs,ylim=c(5,25),xlim=c(0.5,1),type="l",axes=F,col=NA,xlab=bquote(tau), ylab=bquote(e[tau]~q[tau]))

# points(taus,qse,pch=16,col=scales::alpha(2,0.7),cex=0.5)
# points(taus,expse,pch=16,col=scales::alpha(4,0.7),cex=0.5)
lines(taus,exps,col=scales::alpha(4,0.9))
lines(taus,qs,col=scales::alpha(2,0.9))

# points(taus,qse2,pch=1,col=scales::alpha(2,0.7),cex=0.5)
# points(taus,expse2,pch=1,col=scales::alpha(4,0.7),cex=0.5)
lines(taus, exps2,col=scales::alpha(4,0.9) ,lty=2, lwd=2.5)
lines(taus,qs2,col=scales::alpha(2,0.9),lty=2,lwd=2.5)

axis(1,cex.axis=0.8)
axis(2,cex.axis=0.8,las=1)
legend("topleft",col=c(scales::alpha(2,0.9),scales::alpha(4,0.9)),lwd=c(2,2),legend=c(bquote(d[1]^"*"==q[tau]),bquote(d[2]^"*"==e[tau])),bty="n")
legend(0.71,25,col=c(1),lwd=c(2,2),lty=c(1,2),legend=c("route 1","route 2"),bty="n")
##################################################


# plot(taus,qs,ylim=c(4,20),xlim=c(0.95,1),type="l",col=scales::alpha(2,0.3),axes=F,
#      xlab=bquote(tau), ylab=bquote(e[tau]~q[tau]))
# lines(taus,exps,col=scales::alpha(4,0.3))
# points(taus,qse,pch=16,col=scales::alpha(2,0.4),cex=0.7)
# points(taus,expse,pch=16,col=scales::alpha(4,0.4),cex=0.7)
# axis(1,cex.axis=0.8)
# axis(2,cex.axis=0.8,las=1)
# legend("topleft",col=c(scales::alpha(2,0.5),scales::alpha(4,0.5)),lwd=c(2,2),legend=c(bquote(d[1]^"*"==q[tau]),bquote(d[2]^"*"==e[tau])),bty="n")
# legend(0.95,15,col=c(scales::alpha(2,0.5),scales::alpha(4,0.5)),pch=c(16,16),legend=c(bquote(hat(d^"*")[1]==hat(q)[tau]),bquote(hat(d^"*")[2]==hat(e)[tau])),bty="n")
# par(xpd=T)
# #arrows(0.999,-1,0.999,qs[taus==0.9991]+0.1,lty=2,col="gray44",code=0,lwd=1)
# text(0.999,-1,bquote(tau==0.999),col="gray44",cex=0.8,pos=1)
```

As shown in Figure \@ref(fig:choices), the optimal departure times under $U_1$ are slightly below the optimal departure times under $U_2$ for lower $\tau$-values. For the $\tau$-values between $0.6$ and $0.7$, the quantile departure times are nearly the same for both routes. For higher $\tau$-values, the quantile departure time choices increasingly reflect the right tail of the distribution, leading to a greater divergence between the routes. In contrast, the evolution of the expectile choices remains even, as it takes both the probabilities and magnitudes into account.

For this example, we also estimate the quantile-expectile correspondences $\tau_2(\tau_1)$ for $\tau_1\in(0.5,1)$, as shown in the left plot of Figure \@ref(fig:figcor2) for both routes, to directly compare the resulting TTRRs. The TTRR curves as functions of $\tau$ are obtained using \@ref(eq:etdev) and \@ref(eq:etvar) and are illustrated in the right panel of Figure \@ref(fig:figcor2). The $\rho_2$-values on the figure are adjusted using the estimated correspondences $\hat\tau_2(\tau_1)$ and \@ref(eq:tcor). The TTRR curves associated with $U_1$ cross at $\tau=0.65$, indicating mixed preferences. The TTRRs associated with $U_2$ for route 2 are consistently higher than those for route 1 at the same $\tau$, reflecting its greater exposure to extreme travel times.

```{r}
ratios<-seq(1,200,0.1)
taus<-1 / (1+1/ratios)
#taus<-c(seq(0.5,0.99,0.01),0.999)
taus<-c(seq(0.5,0.99,0.01))
ratios<-taus/(1-taus)
#which(taus==0.999)
```

```{r}
# as if the estimated model were the true model
ys<-z
exps<-sapply(taus,expectreg::expectile, x=ys)
qs<-sapply(taus,quantile, x=ys)
exps2<-sapply(taus,expectreg::expectile, x=ys2)
qs2<-sapply(taus,quantile, x=ys2)

# estimated
expse<-sapply(taus,expectreg::expectile, x=tt)
qse<-sapply(taus,quantile, x=tt)
```

```{r}
#expectile and quantile ranges
delt1<-(qs-quantile(ys,1-taus))/median(ys)
delt2<-(exps-expectreg::expectile(ys,1-taus))/mean(ys)

#empirical
delt1e<-(qse-quantile(tt,1-taus))/median(tt)
delt2e<-(expse-expectreg::expectile(tt,1-taus))/mean(tt)

#ttrrs
beta = 1
alpha=2*beta


ttrrfun<-function(ys,tau,beta,gamma,alpha,type=1){
  gamma = tau*beta/(1-tau)
  yss<-(ys-mean(ys))/sd(ys)
  if(type==1){
    qyss<-quantile(yss,tau)
  } else {
    qyss<-expectreg::expectile(yss,tau)
  }
  ttrr<-(gamma+beta)/alpha*(tau*mean((yss-qyss)[yss>qyss]^(type)) + (1-tau)*mean((qyss -yss)[yss<=qyss]^(type)))
  return(ttrr)
}
ttrr1<-sapply(taus[-length(taus)],ttrrfun,ys=ys,beta=beta,gamma=gamma,alpha=alpha,type=1)
ttrr2<-sapply(taus[-length(taus)],ttrrfun,ys=ys,beta=beta,gamma=gamma,alpha=alpha,type=2)
#length(ttrr1)
ttrr12<-sapply(taus[-length(taus)],ttrrfun,ys=ys2,beta=beta,gamma=gamma,alpha=alpha,type=1)
ttrr22<-sapply(taus[-length(taus)],ttrrfun,ys=ys2,beta=beta,gamma=gamma,alpha=alpha,type=2)

#empirical
ttrr1e<-sapply(taus,ttrrfun,ys=tt,beta=beta,gamma=gamma,alpha=alpha,type=1)
ttrr2e<-sapply(taus,ttrrfun,ys=tt,beta=beta,gamma=gamma,alpha=alpha,type=2)
```

```{r figcor2, out.width="100%", fig.height = 3, fig.width = 10, fig.cap = "Left panel: Quantile-expectile correspondences for the considerred travel time data. Right panel: TTRRs for both utility specifications for the considerred travel time data and utility parameters $\\beta=1$, $\\alpha=2\\beta$, and $\\gamma = \\beta\\tau/(1-\\tau)$ for the $\\tau_2$-values matched on the $\\tau_1$-values through the estimated quantile-expectile correspondence."}
par(mfrow=c(1,2),mar=c(4,3,2,2))

#quantile-expectile correspondece route 1
alphas<-sapply(exps[-length(taus)],function(x,q){sum(x<q)/length(x)},x=ys)
tau_new = approx(taus[-length(taus)], alphas[-length(taus)], xout=taus)#linear interpolation
tau_new$y<-tau_new$y[-length(tau_new$y)]
tau_new$x<-tau_new$x[-length(tau_new$x)]

#quantile-expectile correspondece route 2
alphas2<-sapply(exps2,function(x,q){sum(x<q)/length(x)},x=ys2)
tau_new2 = approx(taus, alphas2, xout=taus) #linear interpolation
tau_new2$y<-tau_new2$y[-length(tau_new2$y)]
tau_new2$x<-tau_new2$x[-length(tau_new2$x)]

#tau_neww = approx(c(seq(0.4,0.49,0.01),taus), alphas, xout=taus) # some what more tau vals
#tau_new$y[tau_new$x==cmp[2]]<-NA
ttrr2em<-sapply(tau_new$y,ttrrfun,ys=ys,beta=beta,gamma=gamma,alpha=alpha,type=2)# 'matched' rho2 according to the correspondence
ttrr22em<-sapply(tau_new2$y,ttrrfun,ys=ys2,beta=beta,gamma=gamma,alpha=alpha,type=2)# 'matched' rho2 according to the correspondence
#empirical
ttrr2eem<-sapply(tau_new$y,ttrrfun,ys=tt,beta=beta,gamma=gamma,alpha=alpha,type=2)
#t0<-tau_new$y[tau_new$x==0.999]
#gg0<-beta*t0/(1-t0)

plot(c(tau_new$x),c(tau_new$y),type="l",ylim=c(0.5,1), xlim=c(0.5,1),axes=F, ylab="",xlab="",lwd=2)
lines(c(tau_new2$x),c(tau_new2$y), lty=2, lwd=2, col="gray44")
for(i in seq(1,50,5)){
  arrows(0,tau_new$y[i],tau_new$x[i],tau_new$y[i],lty=1, col=scales::alpha(4,0.5),code=0, lwd=0.5)
  arrows(0,tau_new2$y[i],tau_new2$x[i],tau_new2$y[i],lty=2, col=scales::alpha(4,0.5),code=0, lwd=0.5)
  arrows(tau_new$x[i],0,tau_new$x[i],tau_new2$y[i],lty=1, col=scales::alpha(2,0.5),code=0, lwd=0.5)
}
#points(cmp[2],tau_new$y[tau_new$x==cmp[2]],pch=16,cex=0.5,col="white")
#points(cmp[2],tau_new$y[tau_new$x==cmp[2]],cex=0.5,col="red")

par(xpd=T)
text(0.75,0.3,bquote(tau[1]))
text(0.41,0.75,bquote(tau[2]))
axis(1, at = seq(0.5,1,0.05), labels=seq(0.5,1,0.05))
axis(2,las=1)
legend(0.7,1.1,col=c(1, "gray44"),lwd=c(2,2),lty=c(1,2),legend=c("route 1","route 2"),bty="n")
# #expectile and quantile ranges
# 
# plot(taus, delt1,type="l",col=2, xlab=bquote(tau),ylab=bquote(Delta[1]~Delta[2]))
# lines(taus,delt2,col=4)
######################################################
# #ttrrs
# par(xpd=F)
# plot(taus, scale01(ttrr1),type="l",col=2, xlab=bquote(tau),ylab=bquote(rho[1]~rho[2]), ylim=c(0,1),xlim=c(0.5,1),axes=F,lwd=2)
# lines(taus,scale01(ttrr2),col=4,lwd=2)
# #points(taus,scale01(ttrr1e),col=scales::alpha(2,0.5), pch =16, cex=0.5)
# #points(taus,scale01(ttrr2e),col=scales::alpha(4,0.5), pch =16, cex=0.5)
# axis(1)
# axis(2,las=1)
# text(0.75,-20,bquote(tau))
# #text(0.41,0.75,bquote(tau[2]))
# legend("topleft",col=c(2,4),lwd=c(2,2),legend=c(bquote(rho[1](tau)),bquote(rho[2](tau))),bty="n",cex=1.5)

######################################################
#ttrrs tau-adjusted
par(xpd=F, lwd=2)

plot(taus[-length(taus)],ttrr1, type="l",col=2, axes=F, ylim=c(0,15), xlim=c(0.5,1), ylab="",xlab="")
lines(taus[-length(taus)],ttrr12,type="l",col=2, lty=2)
lines(taus[-length(taus)],ttrr2em,type="l",col=4, lty=1)
lines(taus[-length(taus)],ttrr22em,type="l",col=4, lty=2)

# plot(taus[-length(taus)], scale01(ttrr1),type="l",col=scales::alpha(2,0.5), 
#      xlab=bquote(tau),ylab=bquote(rho[1]~rho[2]), ylim=c(0,1),xlim=c(0.5,1),axes=F,lwd=2)
# lines(taus[-length(taus)],scale01(ttrr12),col=scales::alpha(2,0.5),lwd=2, lty=2)
# lines(taus[-length(taus)],scale01(ttrr2em),col=scales::alpha(4,0.5),lwd=2, lty=1)
# lines(taus[-length(taus)],scale01(ttrr22em),col=scales::alpha(4,0.5),lwd=2, lty=2)

axis(1, at = seq(0.5,1,0.05), labels=seq(0.5,1,0.05))
axis(2,las=1)
par(xpd=T)
text(0.75,-6,bquote(tau[1,2]))
legend(0.5,17,col=c(2,4),lwd=c(2,2),legend=c(bquote(rho[1](tau[1])),bquote(rho[2](tau[2](tau[1])))),bty="n",cex=1)
legend(0.75,17,col=c(1),lwd=c(2,2),lty=c(1,2),legend=c("route 1","route 2"),bty="n")
```


Overall, in the application above, we used a mixture of gamma distributions to model travel times and obtained optimal departure time choices for $U_1(d,T)$ and $U_2(d,T)$ across various preference combinations. The application demonstrates the advantages of our new expectile-based utility specification, which delivers more plausible departure time choices in line with the risk profile of each route to all preference specifications. Additionally, the TTRR values based on $U_2$ and computed via the sample $\tau$-variance clearly reflect the higher risk exposure of route 2 compared to route 1, unlike the TTRRs derived from $U_1$. This provides potential advantages for modeling risk perception in transportation networks in general and for individual route choice considerations in particular.

# Conclusion

In this paper, we examine two specifications of scheduling utility: the classical asymmetric linear function of early and late delays and a new specification based on the asymmetric quadratic loss. Our framework connects the resulting optimal departure time choices, represented as tail indices of the travel time distribution, with the characteristics of the travel time distribution. This framework introduces a new type of scheduling utility function, which allows for well-defined expected utility maximizers across various travel time distributions and simplifies the calculation of travel time reliability ratios induced by the considered utility types.

Specifically, we show that the optimal departure choices for both utilities are the tail indices of the travel time distribution and can be analysed as the maximizers of expectations in suitably defined asymmetric norms. For the asymmetric linear specification, those are the quantiles, while for the asymmetric quadratic specification, they are the expectiles. Since expectiles are unique for any distribution with a finite mean, our new asymmetric quadratic specification does not rely on the assumption of an invertible cumulative distribution function. The induced optimal choices are unique for discrete travel time distributions, mixtures of components with non-overlapping supports, and mixtures with discrete and continuous components as in @zheng_fangfang2017 and @depalma2006. Moreover, expectiles are more sensitive than quantiles to changes in the tail regions of the travel time distribution, which is valuable for capturing commuters' sensitivity to extremes as observed by @enide2006, @vanlint_etal08, and @sikka_hanley13.

Additionally, we derive the travel time reliability ratios for both utility types using our expection-in-an-asymmetric-norm approach. We show, that the resulting travel time reliability ratios of the asymmetric quadratic utility specification more clearly reflect the risk profiles of travel time distribution. Moreover, in our formulation, these reliability ratios can be easily estimated using the concepts of the $\tau$-deviation and the $\tau$-variance from @tran2019, via straightforward calculations of their empirical counterparts.

Using a dataset on departure time choices, we test both scheduling loss specifications, finding that the quadratic loss specification more accurately represents actual departure time choices. The strong aversion to late arrivals observed across participants further supports the relevance of our proposed asymmetric quadratic utility specification.

Finally, we apply our approach to travel time data from Montreal, fitting a mixture of gamma components to empirically examine how optimal departure choices evolve with varying preference parameters under both utility specifications. We estimate the quantile-expectile correspondence, compare the resulting travel time reliability ratios, and highlight the advantages of the asymmetric quadratic utility specification, positioning it as a viable alternative to the classical scheduling utility. This approach offers potential benefits for modeling various risk perceptions in transportation networks.

# Declaration of generative AI and AI-assisted technologies in the writing process{-}

Statement: During the preparation of this work the author used ChatGPT in order to improve the readability and language of the manuscript. After using this tool/service, the author reviewed and edited the content as needed and takes full responsibility for the content of the published article.



<!--# Appendix {-}

## Example \@ref(exm:duqande){-}

Note that the inverse expectile function can be computed as:

\begin{equation}\tau(e_\tau) = \frac{\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\}}  {2\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} - \mathbb E\{(Y-e_\tau)\}}.\end{equation}(\#eq:invexpfun)

For a mixture of $m$ non-overlapping  uniforms (disjoint supports) with mixing parameter vector $\mathbf p=(p_1,\ldots,p_m)^\top$ where $p_m=1-\sum_{i=1}^{m-1}p_i$ and support edges $a_1<a_2<\ldots<a_m$, the density function $f(y)$ is specified as follows:
$$f(y)=\sum_{j=1}^m\frac{p_j}{a_{j+1}-a_j}\mathbf 1_{y\in [a_j,a_{j+1}]}.$$

Hence to obtain $\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\}$, we compute:

- for $a_1\leq e_\tau< a_2$:

\begin{align*}\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} &= \int_{a_1}^{e_\tau}(y-e_\tau)\frac{p_1}{a_2-a_1}dy = \frac{p_1}{a_2-a_1}\int_{a_1}^{e_\tau}(y-e_\tau)dy\\
&= \frac{p_1}{a_2-a_1}[(\frac 12y^2-e_\tau y)]_{a_1}^{e_\tau} = -\frac{p_1}{a_2-a_1}\frac 12 (a_1-e_\tau)^2,\end{align*}

- for $a_2\leq e_\tau< a_3$:

\begin{align*}\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} &= \int_{a_1}^{a_2}(y-e_\tau)\frac{p_1}{a_2-a_1}dy + \int_{a_2}^{e_\tau}(y-e_\tau)\frac{p_2}{a_3-a_2}dy\\
& = \frac{p_1}{a_2-a_1}\frac 12[(y-e_\tau)^2]_{a_1}^{a_2} + \frac{p_2}{a_3-a_2}\frac 12[(y-e_\tau)^2]_{a_2}^{e_\tau}\\
&=\frac{p_1}2\cdot (a_2+a_1-2e_\tau) -\frac{p_2}{a_3-a_2}\frac 12 (a_2-e_\tau)^2,\end{align*}

- for $a_i\leq e_\tau< a_{i+1}, 1<i\leq m$:

\begin{align*}\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} &=\int_{a_1}^{a_{i}}(y-e_\tau)f(y)dy +  \int_{a_i}^{e_\tau}(y-e_\tau)f(y)dy\\
&=\sum_{k=1}^{i-1}\frac{p_k}{a_{k+1}-a_k}\int_{a_k}^{a_{k+1}}(y-e_\tau)dy + \frac{p_i}{a_{i+1}-a_i} \int_{a_i}^{e_\tau}(y-e_\tau)dy\\
&=\frac 12\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac 12 \cdot \frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2\\ &=\left(\sum_{k=1}^{i-1}{p_k}\frac{a_{k+1}+a_{k}}2-p_ke_\tau\right) -\frac 12 \cdot \frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2.\end{align*}

In the expression above, the first term represents the weighted mean-expectile difference of mixture components with supports below the $i$th component and the second term measures weighted expectation below $e_\tau$ for the $i$th component.

Also, we have:

$$\mathbb E(Y-e_\tau)  = \sum_{j=1}^mp_j\left(\frac{a_{j+1}+a_j}2\right) -e_\tau,$$
which is a weighted sum of the component-wise means minus the $\tau$-expectile. Plugging the interval-wise expressions above into \@ref(eq:invexpfun), we obtain the inverse expectile function:

\begin{equation*}\tau(e_\tau) = \begin{cases}
0,&e_\tau<a_1,\\
\frac{-\frac 12\frac{p_1}{a_2-a_1}(a_1-e_\tau)^2}  {-\frac{p_1}{a_2-a_1}(a_1-e_\tau)^2- \frac12\sum_{j=1}^mp_j(a_{j+1}+a_j) + e_\tau} ,&a_1\leq e_\tau< a_2,\\
\frac{\frac 12\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac 12 \cdot \frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2}  {\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2- \frac12\sum_{j=1}^mp_j(a_{j+1}+a_j) + e_\tau} ,&a_i\leq e_\tau< a_{i+1},i=2,\ldots, m\\
1, &e_\tau\geq a_{m+1}.
\end{cases}\end{equation*}

## Example \@ref(exm:qdzheng){-}

To calculate $\mathbb E\{(Y-\mu_\tau)\mathbf 1_{Y\leq\mu_\tau}\}$, we obtain:

- for $a_0\leq e_\tau< a_1$:

$$\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} = (a_0-e_\tau)p_0.$$

Analogous to the previous example, we have:

- for $a_1\leq e_\tau< a_2$:

\begin{align*}\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} &= (a_0-e_\tau)p_0 + \int_{a_1}^{e_\tau}(y-e_\tau)\frac{p_1}{a_2-a_1}dy\\
&= (a_0-e_\tau)p_0 -\frac{p_1}{a_2-a_1}\frac 12 (a_1-e_\tau)^2,\end{align*}

- for $a_2\leq \mu_\tau< a_3$:

\begin{align*}\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} &= (a_0-e_\tau)p_0 + \int_{a_1}^{a_2}(y-e_\tau)\frac{p_1}{a_2-a_1}dy + \int_{a_2}^{e_\tau}(y-\mu_\tau)\frac{p_2}{a_3-a_2}dy\\
&= (a_0-e_\tau)p_0+\frac{p_1}2\cdot (a_2+a_1-2 e_\tau) -\frac{p_2}{a_3-a_2}\frac 12 (a_2-e_\tau)^2,\end{align*}

- for $a_i\leq e_\tau< a_{i+1}, 1<i\leq m$

\begin{align*}\mathbb E\{(Y-e_\tau)\mathbf 1_{Y\leq e_\tau}\} &=(a_0-e_\tau)p_0 + \int_{a_1}^{a_{i}}(y-e_\tau)f(y)dy +  \int_{a_i}^{\mu_\tau}(y-e_\tau)f(y)dy\\
&=(a_0-e_\tau)p_0+ \sum_{k=1}^{i-1}\frac{p_k}{a_{k+1}-a_k}\int_{a_k}^{a_{k+1}}(y-e_\tau)dy + \frac{p_i}{a_{i+1}-a_i} \int_{a_i}^{e_\tau}(y-e_\tau)dy\\
&=(a_0-e_\tau)p_0+ \frac 12\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac 12 \cdot \frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2.
\end{align*}

It holds:

\begin{align*}\mathbb E(Y-e_\tau) &=(a_0-e_\tau)p_0 + \sum_{j=1}^m\frac{p_j}{a_{j+1}-a_j}\int_{a_j}^{a_{j+1}}(y-e_\tau) dy\\
&=(a_0-e_\tau)p_0+ \sum_{j=1}^m\frac{p_j}2(a_{j+1}+a_j-2 e_\tau).\end{align*}

By plugging in the obtained expressions in \@ref(eq:invexpfun), we obtain the inverse expectile function:

\begin{equation*}\tau(\mu_\tau) = \begin{cases}
0,&e_\tau<a_0,\\
(a_0-e_\tau)p_0,&a_0\leq e_\tau<a_1,\\
\frac{(a_0-e_\tau)p_0-\frac 12\frac{p_1}{a_2-a_1}(a_1-e_\tau)^2}  {2(a_0-e_\tau)p_0-\frac{p_1}{a_2-a_1}(a_1-e_\tau)^2- \frac 12\sum_{j=1}^mp_j(a_{j+1}+a_j -2e_\tau)} ,&a_1\leq e_\tau< a_2,\\
\frac{(a_0-e_\tau)p_0+\frac 12\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac 12 \cdot \frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2}  {2(a_0-e_\tau)p_0+\sum_{k=1}^{i-1}p_k\cdot (a_{k+1}+a_{k}-2e_\tau) -\frac{p_i}{a_{i+1}-a_i}(a_i-e_\tau)^2- \frac 12\sum_{j=1}^mp_j(a_{j+1}+a_j -2e_\tau)} ,&a_i\leq e_\tau< a_{i+1},i=2,\ldots, m\\
1, &e_\tau\geq a_{m+1}.
\end{cases}\end{equation*}

## Example \@ref(exm:corrqe){-}

According to @waltrup2015 (Equation 1.3), the quantile-expectile correspondence can be computed as:
$$\tau(\omega)=\frac{-\omega q_\omega(T) + G(q_\omega(T))}{-\mathbb ET - 2G(q_\omega(T)) + (1-2\omega)q_\omega(T)},$$

where $G(q) = \int_{-\infty}^qt~dF(t).$

For $\omega <p$, $q_\omega= a_1 + \frac{a_2-a_1} p\omega$, we have:
$$G(q) = \int_{a_1}^q t\cdot\frac p{a_2-a_1}dt = \frac 12 \frac p{a_2-a_1}(q^2-a_1^2)$$

and for $p<\omega$, $q_\omega = a_3 + \frac{a_4-a_3}{1-p}(\omega-p)$, we have:
$$G(q) = \int_{a_1}^{a_2} t\cdot\frac p{a_2-a_1}dt + \int_{a_3}^q t\cdot\frac {1-p}{a_2-a_1}dt = \frac 12 p(a_1+a_2) + \frac 12 \frac {1-p}{a_4-a_3}(q^2-a_3^2).$$


Hence, we obtain the following quantile-expectile correspondence:

$$\tau(\omega)=\begin{cases}
\frac{-\omega q_\omega+ \frac 12 \frac p{a_2-a_1}(q_\omega^2-a_1^2)}{-\frac{p(a_1+a_2)}{2}-\frac{(1-p)(a_3+a_4)}{2} - \frac p{a_2-a_1}(q_\omega^2-a_1^2) + (1-2\omega)q_\omega},&q_\omega= a_1 + \frac{a_2-a_1} p\omega, \omega <p,\\
\frac{-\omega q_\omega(T) + \frac 12 p(a_1+a_2) + \frac 12 \frac {1-p}{a_4-a_3}(q_\omega^2-a_3^2)}{-\frac{(1-p)(a_3+a_4)}{2} - \frac{3p(a_1+a_2)}2 - \frac {1-p}{a_4-a_3}(q^2-a_3^2) + (1-2\omega)q_\omega},&q_\omega = a_3 + \frac{a_4-a_3}{1-p}(\omega-p), p<\omega.
\end{cases}$$
-->


<!--
```{r}
#checking for discontinuity of tau-Dev
#generate samples from mixture of two normals
m1 = 10
m2 = 100
sd = 10
mpar = 0.1
N=10000

set.seed(1)
u = runif(N)
m12 = ifelse(u>mpar,m1,m2)
rr = rnorm(N,m12,sd)

```

```{r}
taus = seq(0.5,0.99,0.01)
beta = 1
alpha=2*beta

asym_expfun<-function(ys,tau,type=1){
  yss<-(ys-mean(ys))/sd(ys)
  if(type==1){
    qyss<-quantile(yss,tau)
  } else {
    qyss<-expectreg::expectile(yss,tau)
  }
  aexp<-(tau*mean((yss-qyss)[yss>qyss]^(type)) + (1-tau)*mean((qyss -yss)[yss<=qyss]^(type)))
  return(aexp)
}
ttrr1<-sapply(taus[-length(taus)],asym_expfun,ys=rr,type=1)
ttrr2<-sapply(taus[-length(taus)],asym_expfun,ys=rr,type=2)
```

```{r}
par(xpd=F, lwd=2)

plot(taus[-length(taus)],ttrr1, type="l",col=2, axes=F, ylim=c(0,5), xlim=c(0.5,1), ylab="",xlab="")
lines(taus[-length(taus)],ttrr2,type="l",col=4, lty=1)

axis(1, at = seq(0.5,1,0.05), labels=seq(0.5,1,0.05))
axis(2,las=1)
par(xpd=T)
text(0.75,-6,bquote(tau[1,2]))
legend(0.5,17,col=c(2,4),lwd=c(2,2),legend=c(bquote(Dev[tau]),bquote(Var[tau])),bty="n",cex=1)

```
-->
